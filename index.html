<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Splendor">
    
    <title>ç’€ç’¨å®çŸ³ (Splendor) - iPad ç»ˆæä¼˜åŒ–ç‰ˆ V9</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* ä½¿ç”¨ dvh ä¿®å¤ iPad Safari åœ°å€æ é—®é¢˜ */
        html, body { height: 100dvh; width: 100vw; overflow: hidden; background-color: #0f172a; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; touch-action: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        /* æ ¹å®¹å™¨å¸ƒå±€ */
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
        
        /* é¡¶éƒ¨å®‰å…¨åŒºå¡«å……ç±» */
        .safe-top-padding {
            padding-top: max(env(safe-area-inset-top), 12px); 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        
        .prevent-squish { flex-shrink: 0; }
        
        /* çº¹ç† */
        .pattern-dots { background-image: radial-gradient(rgba(255,255,255,0.15) 1.5px, transparent 1.5px); background-size: 15px 15px; }
        .pattern-grid { background-image: linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px); background-size: 20px 20px; }
        .pattern-stripes { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 10px, transparent 10px, transparent 20px); }
        .pattern-checkers { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%, rgba(255,255,255,0.08)), repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%, rgba(255,255,255,0.08)); background-position: 0 0, 10px 10px; background-size: 20px 20px; }
        .pattern-radial-dark { background-image: radial-gradient(circle at center, rgba(0,0,0,0.05) 0%, transparent 70%); }
        .pattern-hex { background-color: #0f172a; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='49' viewBox='0 0 28 49'%3E%3Cg fill-rule='evenodd'%3E%3Cg id='hexagons' fill='%231e293b' fill-opacity='0.4' fill-rule='nonzero'%3E%3Cpath d='M13.99 9.25l13 7.5v15l-13 7.5L1 31.75v-15l12.99-7.5zM3 17.9v12.7l10.99 6.34 11-6.35V17.9l-11-6.34L3 17.9zM0 15l12.98-7.5V0h-2v6.35L0 12.69v2.3zm0 18.5L12.98 41v8h-2v-6.85L0 35.81v-2.3zM15 0v7.5L27.99 15H28v-2.31h-.01L17 6.35V0h-2zm0 49v-7.5l12.99-7.5H28v2.31h-.01L17 42.15V49h-2z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); }
        
        .text-stroke-black { -webkit-text-stroke: 1px rgba(0, 0, 0, 0.8); text-shadow: 0 1px 2px rgba(0,0,0,0.8); paint-order: stroke fill; }
        
        /* åŠ¨ç”» */
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -20px); } 10% { opacity: 1; transform: translate(-50%, 0); } 90% { opacity: 1; transform: translate(-50%, 0); } 100% { opacity: 0; transform: translate(-50%, -20px); } }
        .animate-notification { animation: fadeInOut 2s ease-in-out forwards; }
        @keyframes roll { 0% { transform: rotateX(0deg) rotateY(0deg); } 100% { transform: rotateX(720deg) rotateY(720deg); } }
        .dice-roll { animation: roll 0.5s ease-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. åŸºç¡€é…ç½® ---
        const GEM_TYPES = ['emerald', 'sapphire', 'ruby', 'diamond', 'onyx'];
        const MARVEL_HEROES = ["é’¢é“ä¾ ", "ç¾å›½é˜Ÿé•¿", "é›·ç¥", "ç»¿å·¨äºº", "é»‘å¯¡å¦‡", "é¹°çœ¼", "å¥‡å¼‚åšå£«", "é»‘è±¹", "èœ˜è››ä¾ ", "æƒŠå¥‡é˜Ÿé•¿", "èšäºº", "çŒ©çº¢å¥³å·«", "å¹»è§†", "æ´›åŸº", "ç­éœ¸", "æ˜Ÿçˆµ", "æ ¼é²ç‰¹", "ç«ç®­æµ£ç†Š"];
        
        // è°ƒæ•´å¡ç‰Œå°ºå¯¸ï¼šæ¯” v8 å°ï¼Œé˜²æ­¢çºµå‘é‡å ï¼Œä½†æ¯” v6 å¤§ï¼Œä¿æŒæ¸…æ™°åº¦
        // h-44 (176px) -> 3è¡Œ = 528pxï¼Œåœ¨ iPad æ¨ªå± (768px - header - footer) ç©ºé—´å‹‰å¼ºå¤Ÿç”¨
        const CARD_SIZE_CLASSES = "w-24 h-32 sm:w-28 sm:h-36 md:w-30 md:h-40 lg:w-34 lg:h-44 xl:w-38 xl:h-48"; 
        
        const POINTS_TO_WIN = 15;
        const MAX_GEMS = 10;
        const MAX_RESERVED = 3;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>);
        
        // Emoji å¤´åƒ
        const EmojiAvatar = ({ emoji, size = 24, className = "" }) => (
            <div className={`flex items-center justify-center select-none leading-none ${className}`} style={{ width: size, height: size, fontSize: typeof size === 'number' ? size * 0.75 : '1.5rem' }}>{emoji}</div>
        );
        const JudyIcon = (p) => <EmojiAvatar emoji="ğŸ°" {...p} />;
        const NickIcon = (p) => <EmojiAvatar emoji="ğŸ¦Š" {...p} />;
        const BotIcon = (p) => <EmojiAvatar emoji="ğŸ¤–" {...p} />;
        
        // æ¸¸æˆ UI å›¾æ ‡
        const Crown = (p) => <IconBase {...p}><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/></IconBase>;
        const CrownHome = (p) => <IconBase {...p}><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const Lock = (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const ScrollText = (p) => <IconBase {...p}><path d="M15 12h-5"/><path d="M15 8h-5"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3"/></IconBase>;
        const Grip = (p) => <IconBase {...p}><circle cx="12" cy="5" r="1"/><circle cx="19" cy="5" r="1"/><circle cx="5" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/><circle cx="12" cy="19" r="1"/><circle cx="19" cy="19" r="1"/><circle cx="5" cy="19" r="1"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Undo2 = (p) => <IconBase {...p}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></IconBase>;
        
        // å®çŸ³SVG
        const Diamond = (p) => <IconBase {...p}><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0l-7.59 7.59Z"/></IconBase>;
        const Hexagon = (p) => <IconBase {...p}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></IconBase>;
        const Square = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" /></IconBase>;
        const Circle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10" /></IconBase>;
        const Triangle = (p) => <IconBase {...p}><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3l-8-14z"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;

        const GemIconSVG = ({ type, size = "100%", className = "" }) => {
          if (type === 'diamond') return <Diamond size={size} className={className} strokeWidth={2} />;
          if (type === 'emerald') return <Hexagon size={size} className={className} strokeWidth={2} />;
          if (type === 'ruby') return <Square size={size} className={className} strokeWidth={2} />;
          if (type === 'sapphire') return <Triangle size={size} className={`${className} rotate-180`} strokeWidth={2} />;
          if (type === 'onyx') return <Circle size={size} className={className} strokeWidth={2} />;
          if (type === 'gold') return <Sparkles size={size} className={className} strokeWidth={2} />;
          return null;
        };

        const MiniGem = ({ type }) => {
          const colors = { emerald: 'bg-emerald-500 border-emerald-700', sapphire: 'bg-blue-600 border-blue-800', ruby: 'bg-red-600 border-red-800', diamond: 'bg-slate-200 border-slate-400', onyx: 'bg-slate-800 border-black', gold: 'bg-yellow-400 border-yellow-600' };
          return <div className={`w-2 h-2 lg:w-2.5 lg:h-2.5 rounded-full border ${colors[type]} shadow-sm`}></div>;
        };

        const GEM_STYLES = {
          emerald: { tokenGradient: 'bg-emerald-600', tokenBorder: 'border-emerald-400', cardBg: 'bg-emerald-900', cardBorder: 'border-emerald-500/50', patternClass: 'pattern-dots', accentColor: 'text-emerald-500', shapeFill: 'text-emerald-500/20', costBg: 'bg-emerald-700/80', costColor: 'bg-emerald-500', textColor: 'text-emerald-600', pointColor: 'text-white text-stroke-black', iconFill: 'fill-emerald-500 stroke-black stroke-[1.5px]', label: 'æ—¶é—´å®çŸ³' },
          sapphire: { tokenGradient: 'bg-blue-600', tokenBorder: 'border-blue-400', cardBg: 'bg-blue-900', cardBorder: 'border-blue-500/50', patternClass: 'pattern-grid', accentColor: 'text-blue-500', shapeFill: 'text-blue-500/20', costBg: 'bg-blue-700/80', costColor: 'bg-blue-500', textColor: 'text-blue-600', pointColor: 'text-white text-stroke-black', iconFill: 'fill-blue-500 stroke-black stroke-[1.5px]', label: 'ç©ºé—´å®çŸ³' },
          ruby: { tokenGradient: 'bg-red-600', tokenBorder: 'border-red-400', cardBg: 'bg-rose-900', cardBorder: 'border-red-500/50', patternClass: 'pattern-stripes', accentColor: 'text-rose-500', shapeFill: 'text-rose-500/20', costBg: 'bg-rose-700/80', costColor: 'bg-rose-500', textColor: 'text-rose-600', pointColor: 'text-white text-stroke-black', iconFill: 'fill-rose-500 stroke-black stroke-[1.5px]', label: 'ç°å®å®çŸ³' },
          diamond: { tokenGradient: 'bg-slate-300', tokenBorder: 'border-white', cardBg: 'bg-slate-200', cardBorder: 'border-white/80', patternClass: 'pattern-radial-dark', accentColor: 'text-slate-500', shapeFill: 'text-black/10', costBg: 'bg-slate-300/90', costColor: 'bg-slate-200', textColor: 'text-slate-600', pointColor: 'text-white text-stroke-black', iconFill: 'fill-slate-50 stroke-slate-600 stroke-[1.5px]', label: 'çµé­‚å®çŸ³' },
          onyx: { tokenGradient: 'bg-zinc-700', tokenBorder: 'border-zinc-500', cardBg: 'bg-zinc-700', cardBorder: 'border-zinc-400/50', patternClass: 'pattern-checkers', accentColor: 'text-zinc-400', shapeFill: 'text-white/10', costBg: 'bg-zinc-600/90', costColor: 'bg-zinc-500', textColor: 'text-stone-800', pointColor: 'text-white text-stroke-black', iconFill: 'fill-zinc-800 stroke-black stroke-[1.5px]', label: 'åŠ›é‡å®çŸ³' },
          gold: { tokenGradient: 'bg-yellow-500', tokenBorder: 'border-yellow-200', textColor: 'text-amber-600', label: 'å¿ƒçµå®çŸ³' },
        };
        const LEVEL_CONFIG = { 1: { dotColor: 'text-emerald-400', borderColor: 'border-emerald-500/30', bg: 'bg-emerald-900/20' }, 2: { dotColor: 'text-yellow-400', borderColor: 'border-yellow-500/30', bg: 'bg-yellow-900/20' }, 3: { dotColor: 'text-blue-400', borderColor: 'border-blue-500/30', bg: 'bg-blue-900/20' } };
        
        // 4. æ•°æ®ç”Ÿæˆ
        const REAL_CARDS_LV1 = [[0,0,{1:1,2:1,3:1,4:1}],[0,0,{1:1,2:2,3:1,4:1}],[0,0,{1:2,2:2,4:1}],[0,0,{0:1,1:3,2:1}],[0,0,{2:1,4:2}],[0,0,{0:2,4:2}],[0,0,{0:3}],[1,0,{1:4}],[0,1,{0:1,2:1,3:1,4:1}],[0,1,{0:1,2:2,3:1,4:1}],[0,1,{0:1,2:2,3:2}],[0,1,{2:1,3:3,4:1}],[0,1,{2:2,3:1}],[0,1,{0:2,2:2}],[0,1,{1:3}],[1,1,{2:4}],[0,2,{0:1,1:1,3:1,4:1}],[0,2,{0:1,1:2,3:1,4:1}],[0,2,{0:1,1:1,3:2,4:1}],[0,2,{0:3,1:1,4:1}],[0,2,{0:2,1:1}],[0,2,{1:2,3:2}],[0,2,{2:3}],[1,2,{4:4}],[0,3,{0:1,1:1,2:1,4:1}],[0,3,{0:1,1:1,2:2,4:1}],[0,3,{0:1,1:2,2:2}],[0,3,{0:1,1:1,2:3}],[0,3,{0:2,4:1}],[0,3,{0:2,1:2}],[0,3,{3:3}],[1,3,{0:4}],[0,4,{0:1,1:1,2:1,3:1}],[0,4,{0:1,1:1,2:1,3:2}],[0,4,{0:1,1:2,2:1,3:1}],[0,4,{0:1,2:1,3:3}],[0,4,{1:2,2:1}],[0,4,{2:2,3:2}],[0,4,{4:3}],[1,4,{3:4}]];
        const REAL_CARDS_LV2 = [[1,0,{0:2,1:3,2:3}],[1,0,{0:2,1:2,2:3}],[2,0,{1:5}],[2,0,{0:4,2:1,4:2}],[2,0,{1:5,2:3}],[3,0,{3:6}],[1,1,{1:2,2:3,3:3}],[1,1,{0:2,1:2,2:3}],[2,1,{2:5}],[2,1,{0:2,1:1,3:4}],[2,1,{2:5,3:3}],[3,1,{2:6}],[1,2,{2:2,3:3,4:3}],[1,2,{2:2,3:2,4:3}],[2,2,{4:5}],[2,2,{0:4,3:2,4:1}],[2,2,{0:3,4:5}],[3,2,{0:6}],[1,3,{0:3,1:3,2:2}],[1,3,{0:3,1:3,4:2}],[2,3,{0:5}],[2,3,{0:1,1:4,2:2}],[2,3,{0:5,1:3}],[3,3,{1:6}],[1,4,{0:3,1:2,2:3}],[1,4,{0:3,3:3,4:2}],[2,4,{3:5}],[2,4,{1:1,2:4,3:2}],[2,4,{3:5,4:3}],[3,4,{4:6}]];
        const REAL_CARDS_LV3 = [[3,0,{0:3,1:3,2:5,3:3}],[4,0,{3:7}],[4,0,{0:3,1:6,2:3}],[5,0,{0:3,1:7}],[3,1,{0:3,1:3,2:3,4:5}],[4,1,{4:7}],[4,1,{0:3,1:3,2:6}],[5,1,{1:3,2:7}],[3,2,{0:5,1:3,2:3,4:3}],[4,2,{0:7}],[4,2,{0:6,1:3,4:3}],[5,2,{2:3,3:7}],[3,3,{0:3,2:3,3:3,4:5}],[4,3,{1:7}],[4,3,{0:3,3:6,4:3}],[5,3,{0:7,3:3}],[3,4,{0:3,1:5,3:3,4:3}],[4,4,{2:7}],[4,4,{1:3,2:3,4:6}],[5,4,{2:7,4:3}]];
        const REAL_NOBLES = [{points:3,req:{0:4,1:4}},{points:3,req:{0:4,2:4}},{points:3,req:{0:4,3:4}},{points:3,req:{0:4,4:4}},{points:3,req:{1:4,2:4}},{points:3,req:{1:4,3:4}},{points:3,req:{1:4,4:4}},{points:3,req:{2:4,3:4}},{points:3,req:{2:4,4:4}},{points:3,req:{3:4,4:4}},{points:3,req:{0:3,2:3,3:3}},{points:3,req:{0:3,1:3,4:3}}];

        const shuffleArray = (array) => { const arr = [...array]; for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; };
        const mapCost = (costObj) => { const res = {}; for(let k in costObj) res[GEM_TYPES[k]] = costObj[k]; return res; };
        const mapRealCards = (realData, level) => realData.map((d, i) => ({ id: `l${level}-${i}`, level, points: d[0], bonus: GEM_TYPES[d[1]], cost: mapCost(d[2]) }));
        const generateDeck = () => ({ 1: shuffleArray(mapRealCards(REAL_CARDS_LV1, 1)), 2: shuffleArray(mapRealCards(REAL_CARDS_LV2, 2)), 3: shuffleArray(mapRealCards(REAL_CARDS_LV3, 3)) });
        const generateNobles = (count) => { const shuffledHeroes = shuffleArray([...MARVEL_HEROES]); const mapped = REAL_NOBLES.map((n, i) => ({ id: `noble-${i}`, points: n.points, req: mapCost(n.req), hero: shuffledHeroes[i % shuffledHeroes.length] })); return shuffleArray(mapped).slice(0, count); };

        const GemToken = ({ type, size = 'md', className = "", count, showCount = true }) => {
          const sizeClasses = { sm: 'w-5 h-5 lg:w-6 lg:h-6', md: 'w-7 h-7 lg:w-9 lg:h-9', xl: 'w-10 h-10 lg:w-12 lg:h-12' };
          const style = GEM_STYLES[type];
          return (
            <div className={`prevent-squish relative rounded-full flex items-center justify-center font-bold border-2 ${style.tokenGradient} shadow-md border-opacity-50 ${style.tokenBorder} ${type === 'diamond' ? 'text-slate-800' : 'text-white'} ${sizeClasses[size]} ${className} transition-transform active:translate-y-1 active:shadow-none shrink-0 shadow-black/30`}> 
              <div className={`absolute top-0 left-0 w-full h-1/2 rounded-t-full pointer-events-none ${type === 'diamond' ? 'bg-white/50' : 'bg-white/20'}`}></div>
              <div className="w-[60%] h-[60%] flex items-center justify-center fill-current"><GemIconSVG type={type} /></div>
              {showCount && count !== undefined && (<span className="absolute -bottom-1 -right-1 bg-black text-white text-[9px] lg:text-[10px] min-w-[16px] h-4 lg:h-5 flex items-center justify-center rounded-full border border-slate-600 shadow-md z-10 px-1">{count}</span>)}
            </div>
          );
        };

        const BonusCardStack = ({ type, count }) => {
          const style = GEM_STYLES[type];
          return (
            <div className={`prevent-squish relative w-8 h-12 lg:w-10 lg:h-14 xl:w-12 xl:h-16 rounded-md border-2 flex items-center justify-center shadow-md transition-transform ${style.cardBg} ${style.cardBorder} group overflow-hidden`}>
               <div className={`absolute inset-0 opacity-30 ${style.patternClass}`}></div>
               {count > 1 && <div className={`absolute top-0.5 right-0.5 w-full h-full rounded border border-inherit bg-inherit opacity-80 -z-10`}></div>}
               {count > 2 && <div className={`absolute top-1 right-1 w-full h-full rounded border border-inherit bg-inherit opacity-60 -z-20`}></div>}
               <div className={`drop-shadow-md z-10`}><GemIconSVG type={type} size="60%" className={style.iconFill} /></div>
               <div className={`absolute inset-0 flex items-center justify-center z-20`}><span className={`font-black text-white text-stroke-black text-base lg:text-lg xl:text-xl`}>{count}</span></div>
            </div>
          );
        };

        const Card = ({ card, canBuy, onBuy, isReserving, isReservedView = false, inModal = false, customSizeClass }) => {
          const style = GEM_STYLES[card.bonus];
          const canReserve = isReserving && !isReservedView;
          const sizeClass = customSizeClass || (inModal ? 'w-48 h-64 scale-100' : CARD_SIZE_CLASSES);

          return (
            <div className={`prevent-squish relative group flex flex-col justify-between ${sizeClass} rounded-lg lg:rounded-xl transition-all duration-300 ${style.cardBg} border-2 overflow-hidden shadow-xl ${canReserve ? 'ring-4 ring-yellow-400 cursor-pointer animate-pulse z-20' : ''} ${canBuy && !isReserving ? 'ring-2 lg:ring-4 ring-green-400/80 cursor-pointer -translate-y-1 lg:-translate-y-2 shadow-green-900/50 z-10' : `${style.cardBorder} ${!isReserving ? 'hover:z-10' : ''}`}`} onClick={() => { if (canReserve) onBuy(card, 'reserve'); else if (canBuy) onBuy(card, 'buy'); }}>
              <div className={`absolute inset-0 opacity-30 pointer-events-none ${style.patternClass}`}></div>
              <div className={`absolute inset-0 flex items-center justify-center pointer-events-none transition-transform duration-500 group-hover:scale-110 ${style.shapeFill}`}><GemIconSVG type={card.bonus} size={100} className="fill-current" /></div>
              <div className={`flex justify-between items-start p-2 lg:p-3 z-10 relative`}>
                <div className={`text-3xl lg:text-4xl xl:text-5xl font-serif font-black ${style.pointColor} drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)] leading-none mt-0.5 lg:mt-1 ml-0.5 lg:ml-1 filter`}>{card.points > 0 ? card.points : ''}</div>
                <div className={`w-7 h-7 lg:w-9 lg:h-9 xl:w-10 xl:h-10 rounded-full flex items-center justify-center shadow-xl border-2 bg-white border-white`}><GemIconSVG type={card.bonus} size={20} className={`${style.iconFill} lg:scale-110`} /></div>
              </div>
              {canReserve && <div className="absolute inset-0 bg-yellow-500/10 flex items-center justify-center pointer-events-none"><Lock size={32} className="text-yellow-200 drop-shadow-md" /></div>}
              <div className={`mt-auto p-1 lg:p-1.5 flex flex-col gap-1 backdrop-blur-md border-t border-white/10 z-10 rounded-b-lg ${style.costBg}`}>
                <div className="flex flex-nowrap gap-0.5 lg:gap-1.5 items-end justify-center min-h-[20px] lg:min-h-[24px]">
                  {Object.entries(card.cost).map(([type, amount]) => (<div key={type} className={`flex items-center justify-center w-5 h-5 lg:w-6 lg:h-6 xl:w-7 xl:h-7 rounded-full border-2 ${GEM_STYLES[type].tokenGradient} ${GEM_STYLES[type].tokenBorder} ${type === 'diamond' ? 'text-slate-900' : 'text-white'} text-[10px] lg:text-xs xl:text-sm font-black shadow-sm`}>{amount}</div>))}
                </div>
              </div>
              <div className={`absolute top-1/2 -translate-y-1/2 left-1 flex flex-col gap-1 opacity-30`}>{Array(card.level).fill(0).map((_, i) => (<div key={i} className="w-1 h-1 lg:w-1.5 lg:h-1.5 rounded-full bg-white shadow"></div>))}</div>
            </div>
          );
        };

        const NobleTile = ({ noble }) => (
          <div className={`prevent-squish w-full min-h-[120px] flex-1 rounded-lg border-4 border-amber-500/50 relative overflow-hidden shrink-0 bg-gradient-to-br from-amber-100 via-yellow-100 to-amber-200 mb-1.5`}>
            <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] mix-blend-overlay"></div>
            
            {/* Hero Name Header */}
            <div className="absolute top-0 inset-x-0 bg-amber-500/20 py-0.5 text-center border-b border-amber-500/10 z-10">
                <span className="text-[10px] lg:text-xs font-black text-amber-900 leading-none block truncate px-1">{noble.hero}</span>
            </div>

            {/* Left-Top: Points (Adjusted) */}
            <div className="absolute top-6 left-2 text-3xl lg:text-4xl font-serif font-black text-amber-900 leading-none drop-shadow-sm z-10 pl-1">{noble.points}</div>

            {/* Left-Bottom: Crown (Exactly 65px as requested) */}
            <div className="absolute bottom-1 left-1 opacity-40 text-amber-600 z-0"><Crown size={65} /></div>

            {/* Right Side: Requirements (Vertical Column - Smaller Icons) */}
            <div className="absolute top-6 right-2 bottom-1 flex flex-col gap-0.5 items-end justify-start z-10">
                {Object.entries(noble.req).map(([type, amt]) => (
                    <div key={type} className="flex justify-between items-center bg-white/80 rounded px-1 py-0.5 shadow-sm border border-amber-200/50 min-w-[32px]">
                        <div className="scale-90"><MiniGem type={type} /></div>
                        <span className="text-[10px] font-black text-amber-950 ml-1">{amt}</span>
                    </div>
                ))}
            </div>
          </div>
        );

        const MiniNoble = ({ noble }) => (
           <div className="prevent-squish w-10 h-10 lg:w-12 lg:h-12 xl:w-14 xl:h-14 rounded border-2 border-amber-300 bg-gradient-to-br from-amber-100 to-amber-300 shadow-md flex items-center justify-center relative group cursor-help shrink-0">
              <div className="absolute top-0 left-0 text-[10px] lg:text-xs font-black text-amber-900 p-0.5 leading-none">{noble.points}</div>
              <Crown size={20} className="text-amber-600 opacity-50" />
           </div>
        );

        const Notification = ({ msg, type = 'error' }) => (
            <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[60] animate-notification pointer-events-none">
                <div className={`${type === 'success' ? 'bg-amber-500/90 border-amber-400' : 'bg-red-500/90 border-red-400'} backdrop-blur text-white px-6 py-4 rounded-xl shadow-2xl border-2 flex items-center gap-3`}>
                    {type === 'success' ? <Crown size={32} className="text-white shrink-0" strokeWidth={2.5}/> : <AlertCircle size={32} className="text-white shrink-0" strokeWidth={2.5}/>}
                    <span className="font-bold text-lg">{msg}</span>
                </div>
            </div>
        );

        const DiceRollModal = ({ players, onRollComplete }) => {
            const [rolling, setRolling] = useState(false);
            const [results, setResults] = useState(players.map(() => null));
            const [winner, setWinner] = useState(null);

            const roll = () => {
                setRolling(true);
                let rolls = [];
                let uniqueWinnerFound = false;
                while(!uniqueWinnerFound) {
                    rolls = players.map(() => Math.floor(Math.random() * 6) + 1);
                    const maxVal = Math.max(...rolls);
                    const winners = rolls.map((r, i) => r === maxVal ? i : -1).filter(i => i !== -1);
                    if (winners.length === 1) uniqueWinnerFound = true;
                }

                setTimeout(() => {
                    setResults(rolls);
                    const maxVal = Math.max(...rolls);
                    const winnerIdx = rolls.indexOf(maxVal);
                    setWinner(winnerIdx);
                    setRolling(false);
                    setTimeout(() => onRollComplete(winnerIdx), 2000);
                }, 1000);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 safe-top-padding">
                    <div className="bg-slate-800 border-2 border-amber-500 rounded-2xl p-8 max-w-2xl w-full text-center shadow-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6">äº‰å¤ºå…ˆæ‰‹</h2>
                        <div className="flex justify-around mb-8 flex-wrap gap-4">
                            {players.map((p, idx) => (
                                <div key={idx} className="flex flex-col items-center gap-2">
                                    <div className="text-slate-300 font-bold text-sm">{p.name}</div>
                                    <div className={`w-16 h-16 lg:w-20 lg:h-20 bg-slate-700 rounded-xl flex items-center justify-center text-4xl font-black border-2 border-slate-600 ${rolling ? 'animate-bounce' : ''} transition-all ${winner === idx ? 'border-amber-500 bg-amber-900/50 scale-110' : ''}`}>
                                        {rolling ? '?' : (results[idx] || (
                                            p.id === 0 ? (p.character === 'nick' ? <NickIcon size={32}/> : <JudyIcon size={32}/>) : 
                                            p.id === 1 && !p.isComputer ? <NickIcon size={32}/> : 
                                            <BotIcon size={32}/>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        {winner === null ? (
                            <button onClick={roll} disabled={rolling} className="w-full py-3 bg-gradient-to-r from-amber-600 to-yellow-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed">
                                {rolling ? 'æŠ•æ·ä¸­...' : 'æ·éª°å­'}
                            </button>
                        ) : (
                            <div className="text-xl font-bold text-green-400 animate-pulse">
                                {players[winner].name} å…ˆæ‰‹ï¼
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ReservedCardsModal = ({ player, currentPlayer, onClose, onBuy }) => {
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 safe-top-padding" onClick={onClose}>
                <div className="bg-slate-900 border-2 border-slate-700 rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><X size={24}/></button>
                    <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Lock className="text-yellow-500"/> {player.name} çš„é¢„ç•™å¡ç‰‡</h2>
                    {player.reserved.length === 0 ? <div className="text-center py-12 text-slate-500 italic">æš‚æ— é¢„ç•™å¡ç‰‡</div> : (
                        <div className="flex flex-wrap gap-6 justify-center">
                            {player.reserved.map(card => {
                                const canBuy = player.id === currentPlayer.id && onBuy && onBuy(card, 'buy', true);
                                return (
                                    <div key={card.id} className="flex flex-col gap-3 items-center">
                                        <Card card={card} inModal={true} />
                                        {player.id === currentPlayer.id ? (
                                            <button onClick={() => onBuy(card, 'buy')} disabled={!canBuy} className={`px-4 py-2 rounded-full font-bold text-sm transition-all ${canBuy ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg active:scale-95' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}>{canBuy ? 'è´­ä¹°' : 'èµ„æºä¸è¶³'}</button>
                                        ) : (<div className="text-xs text-slate-500 font-bold uppercase tracking-wider">ä»…æŸ¥çœ‹</div>)}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            </div>
          );
        };

        const TopPlayerStats = ({ player }) => (
            <div className="flex flex-row gap-2 w-full items-center justify-center">
                {/* Gems Row - compacted */}
                <div className="flex gap-0.5 bg-slate-900/50 px-1 py-0.5 rounded-lg border border-slate-700/50 justify-center">
                    {GEM_TYPES.map(g => (
                        <div key={g} className="flex items-center">
                            <div className={`w-2 h-2 rounded-full ${GEM_STYLES[g].tokenGradient} border ${GEM_STYLES[g].tokenBorder} ${player.gems[g]>0?'shadow-sm':'opacity-30'}`}></div>
                            <span className={`text-[9px] font-bold ml-0.5 ${player.gems[g]>0?'text-white':'text-slate-600'}`}>{player.gems[g]}</span>
                        </div>
                    ))}
                    <div className="flex items-center border-l border-slate-700/50 pl-0.5 ml-0.5">
                        <div className="w-2 h-2 rounded-full bg-yellow-500 border border-yellow-200"></div>
                        <span className={`text-[9px] font-bold ml-0.5 ${player.gems.gold>0?'text-yellow-500':'text-slate-600'}`}>{player.gems.gold}</span>
                    </div>
                </div>
                
                {/* Divider */}
                <div className="w-px h-3 bg-slate-600/50"></div>

                {/* Cards Row - compacted */}
                <div className="flex gap-0.5 bg-slate-900/50 px-1 py-0.5 rounded-lg border border-slate-700/50 justify-center">
                    {GEM_TYPES.map(g => (
                         <div key={g} className="flex items-center">
                            <div className={`w-2 h-2.5 rounded-sm border ${GEM_STYLES[g].cardBorder} ${GEM_STYLES[g].cardBg} ${player.bonuses[g]>0?'shadow-sm':'opacity-30'}`}></div>
                            <span className={`text-[9px] font-bold ml-0.5 ${player.bonuses[g]>0?'text-white':'text-slate-600'}`}>{player.bonuses[g]}</span>
                        </div>
                    ))}
                </div>
            </div>
        );

        // --- æ¸¸æˆé…ç½®å¼¹çª— ---
        const ConfigModal = ({ config, setConfig, onStart, onClose }) => {
            const { playerCount, humanCount, difficulty, playerChar } = config;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in safe-top-padding">
                    <div className="bg-slate-900/90 backdrop-blur-md p-8 rounded-2xl border border-amber-500/30 shadow-[0_0_50px_rgba(0,0,0,0.5)] w-full max-w-md relative z-20 animate-slide-up">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><X size={24}/></button>
                        <h2 className="text-center text-amber-500 font-bold mb-6 tracking-wider uppercase text-sm border-b border-amber-500/20 pb-2">æ¸¸æˆé…ç½®</h2>
                        
                        <div className="mb-6 space-y-3">
                            <label className="text-xs text-slate-400 uppercase tracking-widest font-bold">ç©å®¶äººæ•°</label>
                            <div className="grid grid-cols-3 gap-3">
                                {[2, 3, 4].map(n => (
                                    <button key={n} onClick={() => setConfig({...config, playerCount: n, humanCount: n === 2 ? 2 : Math.min(humanCount, n)})} 
                                        className={`py-3 rounded-lg font-bold border transition-all relative overflow-hidden group ${playerCount === n ? 'bg-amber-600 border-amber-500 text-white shadow-lg shadow-amber-900/50' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700 hover:border-slate-600'}`}>
                                        <span className="relative z-10">{n} äºº</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="mb-6 space-y-3">
                             <div className="flex justify-between items-end">
                                <label className="text-xs text-slate-400 uppercase tracking-widest font-bold">äººç±»ç©å®¶</label>
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                {Array.from({length: Math.min(2, playerCount)}, (_, i) => i + 1).map(n => (
                                    <button key={n} onClick={() => setConfig({...config, humanCount: n})} 
                                        className={`py-3 rounded-lg font-bold border transition-all relative overflow-hidden ${humanCount === n ? 'bg-emerald-600 border-emerald-500 text-white shadow-lg shadow-emerald-900/50' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}`}>
                                        <div className="flex items-center justify-center gap-2 relative z-10">
                                            <span>{n} äººç±»</span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* è§’è‰²é€‰æ‹©ï¼šä»…å½“ 1 ä¸ªå› ä¸ºç©å®¶æ—¶æ˜¾ç¤º */}
                        {humanCount === 1 && (
                            <div className="mb-6 space-y-3">
                                <label className="text-xs text-slate-400 uppercase tracking-widest font-bold">é€‰æ‹©ä½ çš„è§’è‰²</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => setConfig({...config, playerChar: 'judy'})} 
                                        className={`py-2 rounded-lg font-bold border transition-all flex items-center justify-center gap-2 ${playerChar === 'judy' ? 'bg-blue-600 border-blue-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>
                                        <JudyIcon size={24}/> æœ±è¿ª
                                    </button>
                                    <button onClick={() => setConfig({...config, playerChar: 'nick'})} 
                                        className={`py-2 rounded-lg font-bold border transition-all flex items-center justify-center gap-2 ${playerChar === 'nick' ? 'bg-orange-600 border-orange-500 text-white' : 'bg-slate-800 border-slate-700 text-slate-400'}`}>
                                        <NickIcon size={24}/> å°¼å…‹
                                    </button>
                                </div>
                            </div>
                        )}

                        {playerCount > humanCount && (
                            <div className="mb-8 space-y-3">
                                <label className="text-xs text-slate-400 uppercase tracking-widest font-bold">AI éš¾åº¦</label>
                                <div className="grid grid-cols-3 gap-3">
                                    {['easy', 'normal', 'hard'].map(d => (
                                        <button key={d} onClick={() => setConfig({...config, difficulty: d})} 
                                            className={`py-2 rounded-lg font-bold border capitalize transition-all text-sm ${difficulty === d ? 'bg-purple-600 border-purple-500 text-white shadow-lg shadow-purple-900/50' : 'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}`}>
                                            {d === 'easy' ? 'ç®€å•' : d === 'normal' ? 'æ™®é€š' : 'å›°éš¾'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <button onClick={onStart} className="w-full py-4 bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-400 hover:to-yellow-500 rounded-xl text-white font-black text-lg shadow-xl shadow-amber-900/40 transform transition-all active:scale-[0.98] relative overflow-hidden group">
                            <span className="relative z-10 flex items-center justify-center gap-2">å¼€å§‹æ¸¸æˆ <Crown size={20} /></span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- ä¸»æ¸¸æˆé€»è¾‘ ---
        function SplendorGame() {
          const [gameState, setGameState] = useState('setup');
          const [setupConfig, setSetupConfig] = useState({ playerCount: 2, humanCount: 2, difficulty: 'normal', playerChar: 'judy' });
          const [showConfig, setShowConfig] = useState(false);
          const [deck, setDeck] = useState(null);
          const [board, setBoard] = useState({ 1: [], 2: [], 3: [] });
          const [nobles, setNobles] = useState([]);
          const [bank, setBank] = useState({});
          const [players, setPlayers] = useState([]);
          const [turn, setTurn] = useState(0);
          const [selectedGems, setSelectedGems] = useState([]);
          const [logs, setLogs] = useState([]);
          const [winner, setWinner] = useState(null);
          const [history, setHistory] = useState([]);
          const [viewingReservedPlayer, setViewingReservedPlayer] = useState(null);
          const [notification, setNotification] = useState(null);
          const [notifType, setNotifType] = useState('error');
          const [isReserving, setIsReserving] = useState(false);
          const logsEndRef = useRef(null);

          const currentPlayer = players.length > 0 ? players[turn % players.length] : null;
          const isHumanTurn = currentPlayer && !currentPlayer.isComputer;

          const showNotification = (msg, type = 'error') => { setNotification(msg); setNotifType(type); setTimeout(() => setNotification(null), 3000); };
          const addLog = (msg) => setLogs(prev => [...prev, msg].slice(-20));
          const totalGems = (player) => Object.values(player.gems).reduce((a, b) => a + b, 0);

          useEffect(() => {
              if (gameState === 'playing' && currentPlayer?.isComputer && !winner) {
                  const timer = setTimeout(() => executeAIMove(), 1500);
                  return () => clearTimeout(timer);
              }
          }, [turn, gameState, winner]);

          useEffect(() => { logsEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [logs]);

          const saveState = () => { setHistory(prev => [...prev, JSON.stringify({ deck, board, nobles, bank, players, turn, logs })]); };
          const undo = () => {
              if (history.length === 0 || !isHumanTurn) return;
              const lastState = JSON.parse(history[history.length - 1]);
              setDeck(lastState.deck); setBoard(lastState.board); setNobles(lastState.nobles); setBank(lastState.bank); setPlayers(lastState.players); setTurn(lastState.turn); setLogs(lastState.logs); setHistory(prev => prev.slice(0, -1)); setSelectedGems([]); setIsReserving(false); showNotification("å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ", 'success');
          };

          const executeAIMove = () => {
              const p = currentPlayer;
              const difficulty = setupConfig.difficulty;
              const allCards = [...p.reserved, ...board[1], ...board[2], ...board[3]];
              let affordable = allCards.filter(c => canAfford(p, c));
              
              if (affordable.length > 0) {
                  if (difficulty === 'easy') {
                      const target = affordable[Math.floor(Math.random() * affordable.length)];
                      handleBuyCard(target, p.reserved.some(r => r.id === target.id), false);
                  } else {
                      affordable.sort((a, b) => b.points - a.points || a.level - b.level);
                      handleBuyCard(affordable[0], p.reserved.some(r => r.id === affordable[0].id), false);
                  }
                  return;
              }

              const availableTypes = GEM_TYPES.filter(t => bank[t] > 0);
              if (availableTypes.length >= 3 && totalGems(p) <= 7) {
                  const toTake = availableTypes.slice(0, 3);
                  const newBank = { ...bank }; const newPlayer = { ...p, gems: { ...p.gems } };
                  toTake.forEach(g => { newBank[g]--; newPlayer.gems[g]++; });
                  setBank(newBank); const newPlayers = [...players]; newPlayers[turn % players.length] = newPlayer; setPlayers(newPlayers);
                  addLog(`${p.name} æ‹¿å–: ${toTake.map(g => GEM_STYLES[g].label).join(' ')}`);
                  endTurn(newPlayer);
              } else if (availableTypes.length > 0 && totalGems(p) < MAX_GEMS) {
                  const toTake = availableTypes.slice(0, Math.min(availableTypes.length, MAX_GEMS - totalGems(p)));
                  const newBank = { ...bank }; const newPlayer = { ...p, gems: { ...p.gems } };
                  toTake.forEach(g => { newBank[g]--; newPlayer.gems[g]++; });
                  setBank(newBank); const newPlayers = [...players]; newPlayers[turn % players.length] = newPlayer; setPlayers(newPlayers);
                  addLog(`${p.name} æ‹¿å–: ${toTake.map(g => GEM_STYLES[g].label).join(' ')}`);
                  endTurn(newPlayer);
              } else {
                  if (board[1].length > 0 && p.reserved.length < 3) {
                      handleReserveCard(board[1][0]);
                  } else {
                      endTurn(p); 
                  }
              }
          };

          const canAfford = (player, card) => {
            let missing = 0;
            for (const [type, cost] of Object.entries(card.cost)) {
              const discount = player.bonuses[type];
              const available = player.gems[type];
              const costAfterDiscount = Math.max(0, cost - discount);
              if (available < costAfterDiscount) missing += (costAfterDiscount - available);
            }
            return player.gems.gold >= missing;
          };
          const getAffordCost = (player, card) => {
            let payment = { emerald: 0, sapphire: 0, ruby: 0, diamond: 0, onyx: 0, gold: 0 };
            let goldNeeded = 0;
            for (const [type, cost] of Object.entries(card.cost)) {
              const discount = player.bonuses[type];
              const actualCost = Math.max(0, cost - discount);
              const paidFromGems = Math.min(player.gems[type], actualCost);
              payment[type] = paidFromGems;
              goldNeeded += (actualCost - paidFromGems);
            }
            payment.gold = goldNeeded;
            return payment;
          };

          const handleGemClick = (type) => {
            if (!isHumanTurn) return;
            if (type === 'gold') {
                if (bank.gold <= 0) { showNotification("å¿ƒçµå®çŸ³å·²è¢«æ‹¿å…‰", 'error'); return; }
                if (currentPlayer.reserved.length >= MAX_RESERVED) { showNotification("é¢„ç•™ä½å·²æ»¡", 'error'); return; }
                setIsReserving(!isReserving); setSelectedGems([]); return;
            }
            if (isReserving) setIsReserving(false);
            const countCurrent = selectedGems.filter(g => g === type).length;
            const countTotal = selectedGems.length;
            if (countCurrent === 2) { setSelectedGems([]); return; }
            if (countCurrent === 1) { if (countTotal > 1) { setSelectedGems(selectedGems.filter(g => g !== type)); return; } if (countTotal === 1) { if (bank[type] >= 4) setSelectedGems([type, type]); else setSelectedGems([]); return; } }
            if (bank[type] <= 0) { showNotification("è¯¥å®çŸ³å·²è¢«æ‹¿å…‰", 'error'); return; }
            if (new Set(selectedGems).size !== selectedGems.length) { showNotification("å·²æ‹¿åŒè‰²å®çŸ³", 'error'); return; }
            if (countTotal >= 3) { showNotification("æœ€å¤šæ‹¿3ä¸ª", 'error'); return; }
            setSelectedGems([...selectedGems, type]);
          };

          const confirmTakeGems = () => {
            if (!isHumanTurn) return;
            if (selectedGems.length === 0) return;
            if (totalGems(currentPlayer) + selectedGems.length > MAX_GEMS) { showNotification(`å®çŸ³å·²è¾¾ä¸Šé™!`, 'error'); setSelectedGems([]); return; }
            saveState();
            const newBank = { ...bank }; const newPlayer = { ...currentPlayer, gems: { ...currentPlayer.gems } };
            selectedGems.forEach(g => { newBank[g]--; newPlayer.gems[g]++; });
            setBank(newBank); const newPlayers = [...players]; newPlayers[turn % players.length] = newPlayer; setPlayers(newPlayers);
            addLog(`${currentPlayer.name} æ‹¿å–: ${selectedGems.map(g => GEM_STYLES[g].label).join(' ')}`);
            setSelectedGems([]); endTurn(newPlayer);
          };

          const handleCardInteraction = (card, action, checkOnly = false) => {
              if (!isHumanTurn && !checkOnly) return;
              if (action === 'buy') return handleBuyCard(card, false, checkOnly);
              if (action === 'reserve') return handleReserveCard(card);
          };

          const handleBuyCard = (card, fromReserved = false, checkOnly = false) => {
            if (!canAfford(currentPlayer, card)) { if (!checkOnly && isHumanTurn) showNotification("èµ„æºä¸è¶³ï¼", 'error'); return false; }
            if (checkOnly) return true;
            if (isHumanTurn) saveState();
            const payment = getAffordCost(currentPlayer, card);
            const newBank = { ...bank }; const newPlayer = { ...currentPlayer, gems: { ...currentPlayer.gems }, bonuses: { ...currentPlayer.bonuses } };
            Object.entries(payment).forEach(([type, amt]) => { newBank[type] += amt; newPlayer.gems[type] -= amt; });
            newPlayer.bonuses[card.bonus]++; newPlayer.score += card.points;
            if (fromReserved) { newPlayer.reserved = newPlayer.reserved.filter(c => c.id !== card.id); setViewingReservedPlayer(null); } else { replaceCardOnBoard(card); }
            setBank(newBank); const newPlayers = [...players]; newPlayers[turn % players.length] = newPlayer; setPlayers(newPlayers);
            addLog(`${newPlayer.name} è´­ä¹° (+${card.points})`); checkNoblesVisit(newPlayer);
            return true;
          };

          const handleReserveCard = (card) => {
            if (currentPlayer.reserved.length >= MAX_RESERVED) { if(isHumanTurn) showNotification("é¢„ç•™ä½å·²æ»¡", 'error'); return; }
            if (isHumanTurn) saveState();
            const newPlayer = { ...currentPlayer, gems: { ...currentPlayer.gems }, reserved: [...currentPlayer.reserved, card] };
            const newBank = { ...bank };
            if (newBank.gold > 0) { if (totalGems(newPlayer) < MAX_GEMS) { newBank.gold--; newPlayer.gems.gold++; addLog(`${newPlayer.name} é¢„ç•™+å¿ƒçµå®çŸ³`); } else addLog(`${newPlayer.name} é¢„ç•™ (æ»¡)`); } else addLog(`${newPlayer.name} é¢„ç•™ (æ— å¿ƒçµå®çŸ³)`);
            const newPlayers = [...players]; newPlayers[turn % players.length] = newPlayer; setPlayers(newPlayers);
            replaceCardOnBoard(card); setBank(newBank); setIsReserving(false); endTurn(newPlayer);
          };

          const replaceCardOnBoard = (card) => { const lvl = card.level; const newBoard = { ...board }; const row = newBoard[lvl].filter(c => c.id !== card.id); if (deck[lvl].length > 0) row.push(deck[lvl].pop()); newBoard[lvl] = row; setBoard(newBoard); };
          const checkNoblesVisit = (player) => {
            let visitedSomething = false; const newNobles = [...nobles]; const playerNobles = [...player.visitedNobles]; const newPlayer = { ...player };
            for (let i = newNobles.length - 1; i >= 0; i--) {
              const noble = newNobles[i]; let eligible = true;
              for (const [type, req] of Object.entries(noble.req)) { if (player.bonuses[type] < req) { eligible = false; break; } }
              if (eligible) {
                const msg = `ğŸ‰ è´µæ—æ¥è®¿ï¼${player.name} è·å¾— ${noble.hero}ï¼`; addLog(msg); showNotification(msg, 'success');
                newPlayer.score += noble.points; playerNobles.push(noble); newNobles.splice(i, 1); visitedSomething = true; break;
              }
            }
            if (visitedSomething) { newPlayer.visitedNobles = playerNobles; setNobles(newNobles); const newPlayers = [...players]; newPlayers[turn % players.length] = newPlayer; setPlayers(newPlayers); endTurn(newPlayer); } else { endTurn(newPlayer); }
          };
          const endTurn = (finalPlayerState) => { if (finalPlayerState.score >= POINTS_TO_WIN) { showNotification(`ğŸ† ${finalPlayerState.name} è·èƒœï¼`, 'success'); setWinner(finalPlayerState); setTimeout(() => setGameState('end'), 2000); return; } setTurn(prev => prev + 1); setSelectedGems([]); };

          const startSetup = () => {
             const { playerCount, humanCount, playerChar } = setupConfig;
             const gemCount = playerCount === 2 ? 4 : (playerCount === 3 ? 5 : 7);
             const nobleCount = playerCount + 1;
             
             const initialBank = { emerald: gemCount, sapphire: gemCount, ruby: gemCount, diamond: gemCount, onyx: gemCount, gold: 5 };
             const newDeck = generateDeck();
             const newNobles = generateNobles(nobleCount);
             const newBoard = { 1: newDeck[1].splice(0, 4), 2: newDeck[2].splice(0, 4), 3: newDeck[3].splice(0, 4) };
             setBank(initialBank); setDeck(newDeck); setNobles(newNobles); setBoard(newBoard);
             
             const newPlayers = [];
             
             // --- Player Generation Logic ---
             if (humanCount === 1) {
                 // Single Human (Choice)
                 if (playerChar === 'nick') {
                     newPlayers.push({ id: 0, name: "Nick Wilde", character: 'nick', isComputer: false, gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] });
                 } else {
                     newPlayers.push({ id: 0, name: "Judy Hopps", character: 'judy', isComputer: false, gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] });
                 }
             } else {
                 // 2 Humans (Default)
                 newPlayers.push({ id: 0, name: "Judy Hopps", character: 'judy', isComputer: false, gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] });
                 newPlayers.push({ id: 1, name: "Nick Wilde", character: 'nick', isComputer: false, gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] });
             }

             // Computers
             const botNames = ["Flash", "Chief Bogo", "Clawhauser"];
             let botIdx = 0;
             while(newPlayers.length < playerCount) {
                 newPlayers.push({ id: newPlayers.length, name: botNames[botIdx++] || `Bot ${botIdx}`, isComputer: true, gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] });
             }

             setPlayers(newPlayers);
             setGameState('diceroll');
             setShowConfig(false);
          };
          const handleDiceFinish = (winnerIdx) => { setTurn(winnerIdx); setLogs(["æ¸¸æˆå¼€å§‹ï¼"]); setSelectedGems([]); setWinner(null); setHistory([]); setGameState('playing'); };

          // --- é¦–é¡µè§†å›¾ (ç®€åŒ–ç‰ˆ) ---
          if (gameState === 'setup') {
              return (
                <div className="h-full w-full flex flex-col items-center justify-center bg-[#0f172a] text-white p-4 relative overflow-hidden pattern-hex safe-top-padding">
                    {/* èƒŒæ™¯å…‰å½±æ•ˆæœ */}
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-amber-600/10 rounded-full blur-[100px] pointer-events-none"></div>
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[400px] h-[400px] bg-yellow-500/5 rounded-full blur-[60px] pointer-events-none"></div>

                    <div className="relative z-10 flex flex-col items-center mb-8 animate-float">
                        <CrownHome size={80} className="text-amber-500 mb-4 drop-shadow-[0_0_15px_rgba(245,158,11,0.6)]" />
                        <h1 className="text-6xl md:text-7xl font-serif font-black bg-gradient-to-b from-amber-200 via-amber-400 to-amber-700 bg-clip-text text-transparent tracking-[0.2em] uppercase drop-shadow-lg text-center leading-tight">
                            SPLENDOR
                        </h1>
                        <div className="h-px w-32 bg-gradient-to-r from-transparent via-amber-500 to-transparent my-3 opacity-60"></div>
                        <h2 className="text-xl md:text-2xl font-serif text-slate-400 tracking-[0.5em] uppercase font-light">
                            ç’€ç’¨å®çŸ³
                        </h2>
                    </div>

                    <div className="relative z-20 mt-8">
                        <button 
                            onClick={() => setShowConfig(true)}
                            className="px-12 py-4 bg-gradient-to-r from-amber-500 to-yellow-600 hover:from-amber-400 hover:to-yellow-500 rounded-full text-white font-black text-xl shadow-[0_0_30px_rgba(245,158,11,0.4)] transform transition-all hover:scale-105 active:scale-95 border-2 border-amber-300/30"
                        >
                            å¼€å§‹æ¸¸æˆ
                        </button>
                    </div>
                    
                    <div className="absolute bottom-4 text-slate-600 text-xs font-mono">Designed for iPad Pro</div>

                    {showConfig && (
                        <ConfigModal 
                            config={setupConfig} 
                            setConfig={setSetupConfig} 
                            onStart={startSetup} 
                            onClose={() => setShowConfig(false)} 
                        />
                    )}
                </div>
              );
          }
          if (gameState === 'diceroll') return <DiceRollModal players={players} onRollComplete={handleDiceFinish} />;

          const humanCount = players.filter(p => !p.isComputer).length;
          let bottomPlayers = [], topPlayers = [];
          if (humanCount <= 1) {
              if (players.length === 2 && players[1].isComputer) { bottomPlayers = [players[0]]; topPlayers = [players[1]]; }
              else if (players.length > 2 && humanCount === 1) { bottomPlayers = [players[0]]; topPlayers = players.slice(1); }
              else { bottomPlayers = [players[0], players[1]]; topPlayers = players.slice(2); }
          } else { bottomPlayers = [players[0], players[1]]; topPlayers = players.slice(2); }

          if (!players.length) return null;

          return (
            <div className="h-full w-full bg-[#0f172a] text-slate-200 overflow-hidden font-sans select-none flex flex-col">
              {notification && <Notification msg={notification} type={notifType} />}
              
              {/* é¡¶éƒ¨å®‰å…¨åŒºèƒŒæ™¯æ¡: ä¸“é—¨ç”¨äºå¡«è¡¥ iPad çŠ¶æ€æ  */}
              <div className="w-full bg-slate-900 z-50 shrink-0 safe-top-padding border-b border-slate-800"></div>

              {/* Header: ç´§å‡‘å¸ƒå±€ï¼Œå¼ºåˆ¶é«˜åº¦è‡ªé€‚åº”é˜²æ­¢é‡å  */}
              <div className="h-auto min-h-[5rem] py-2 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-2 lg:px-4 shadow-2xl z-40 shrink-0">
                 <div className="flex items-center gap-2 font-serif font-black text-xl tracking-wide bg-gradient-to-b from-amber-300 to-amber-600 bg-clip-text text-transparent shrink-0"><Crown size={24} strokeWidth={2.5} className="text-amber-500 animate-bounce"/> SPLENDOR</div>
                 
                 {/* Top Players: ä½¿ç”¨ flex-1 å’Œ overflow-hidden é˜²æ­¢æº¢å‡º */}
                 {topPlayers.length > 0 && (
                     <div className="flex-1 flex justify-center gap-2 lg:gap-4 px-2 overflow-hidden mx-2">
                        {topPlayers.map(p => (
                            <div key={p.id} className={`flex flex-col px-2 py-1 rounded-lg border text-xs transition-all shrink-0 min-w-[150px] max-w-[240px] ${p.id === currentPlayer.id ? 'bg-amber-900/50 border-amber-500 animate-pulse ring-1 ring-amber-500/50' : 'bg-slate-800 border-slate-700'}`}>
                                <div className="flex items-center justify-between w-full mb-1">
                                    <div className="flex items-center gap-2 overflow-hidden">
                                        <div className="shrink-0">{p.isComputer ? <BotIcon size={20}/> : (p.character === 'nick'?<NickIcon size={20}/>:<JudyIcon size={20}/>)}</div> 
                                        <div className="font-bold text-slate-300 truncate text-sm">{p.name}</div>
                                    </div>
                                    <span className="text-yellow-500 font-black text-lg shrink-0 ml-1">{p.score}</span>
                                </div>
                                <div className="w-full border-t border-white/10 pt-1 mt-0.5">
                                    <TopPlayerStats player={p} />
                                </div>
                            </div>
                        ))}
                     </div>
                 )}
                 
                 <div className="flex gap-2 shrink-0"><button onClick={undo} disabled={history.length === 0 || !isHumanTurn} className="flex items-center gap-1.5 px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors border border-slate-700 text-xs lg:text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed"><Undo2 size={14}/><span>æ’¤é”€</span></button><button onClick={() => setGameState('setup')} className="flex items-center gap-1.5 px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors border border-slate-700 text-xs lg:text-sm font-bold"><RotateCcw size={14}/><span>é‡ç½®</span></button></div>
              </div>
              
              <div className="flex-1 flex flex-col overflow-hidden relative min-h-0">
                 <div className="flex-1 flex overflow-hidden min-h-0 relative">
                     {/* Left Sidebar: è´µæ— (æ’‘æ»¡é«˜åº¦) */}
                     <div className="w-28 lg:w-32 xl:w-36 bg-[#0f172a] border-r border-slate-800 p-2 flex flex-col gap-2 z-10 shadow-xl shrink-0 h-full overflow-hidden">
                        <div className="text-amber-500 font-serif font-bold text-[10px] lg:text-xs mb-1 uppercase tracking-widest flex items-center justify-center gap-1 w-full border-b border-amber-900/30 pb-1 shrink-0"><Crown size={12} /> è´µæ—</div>
                        <div className="flex-1 flex flex-col gap-3 w-full h-full min-h-0 overflow-y-auto custom-scrollbar pt-1">
                            {nobles.length > 0 ? nobles.map(n => <div key={n.id} className="flex-shrink-0 flex-1 min-h-[90px]"><NobleTile noble={n} /></div>) : (<div className="text-slate-600 italic text-xs py-2">è´µæ—ç¦»åœº</div>)}
                        </div>
                     </div>

                     {/* Center Area */}
                     <div className="flex-1 flex flex-col h-full min-w-0">
                         <div className="flex-1 flex flex-col items-center justify-between relative z-0 overflow-hidden bg-[#0f172a] p-2 min-h-0">
                            {isReserving && <div className="absolute top-2 left-1/2 -translate-x-1/2 bg-yellow-500/90 text-black px-4 py-1 rounded-full font-bold text-sm shadow-lg z-30 animate-bounce pointer-events-none">è¯·é€‰æ‹©ä¸€å¼ å¡ç‰‡è¿›è¡Œé¢„ç•™</div>}
                            <div className="w-full h-full flex flex-col items-center justify-evenly">
                                {[3, 2, 1].map(level => (
                                    <div key={level} className="flex gap-2 lg:gap-4 xl:gap-6 justify-center items-center w-full min-h-0">
                                        <div className={`prevent-squish ${CARD_SIZE_CLASSES} rounded-lg lg:rounded-xl border-2 flex flex-col items-center justify-center shadow-xl relative shrink-0 ${LEVEL_CONFIG[level].bg} ${LEVEL_CONFIG[level].borderColor}`}>
                                            <div className={`text-3xl lg:text-4xl font-serif font-black ${LEVEL_CONFIG[level].dotColor}`}>{Array(level).fill('â—').join('')}</div>
                                            <div className="mt-1 text-[9px] lg:text-[10px] font-bold text-slate-500 uppercase tracking-widest">Deck</div>
                                            <div className="text-xs lg:text-sm font-bold text-white">{deck[level].length}</div>
                                        </div>
                                        {board[level].map(card => (
                                            <Card key={card.id} card={card} canBuy={gameState === 'playing' && canAfford(currentPlayer, card)} isReserving={isReserving} onBuy={handleCardInteraction} />
                                        ))}
                                        {Array(4 - board[level].length).fill(0).map((_, i) => (
                                            <div key={i} className={`prevent-squish ${CARD_SIZE_CLASSES} rounded-lg lg:rounded-xl border-2 border-dashed border-slate-700 bg-slate-800/30 shrink-0`}></div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                         </div>

                         {/* Game Log */}
                         <div className="h-24 lg:h-28 bg-[#0f172a] border-t border-slate-800 flex flex-col shrink-0 relative z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
                            <div className="flex items-center gap-2 px-3 py-1 bg-slate-900/50 text-[10px] lg:text-xs font-bold text-slate-500 uppercase tracking-widest shrink-0 border-b border-slate-800"><ScrollText size={12} /> æ¸¸æˆæ—¥å¿—</div>
                            <div className="flex-1 overflow-y-auto custom-scrollbar p-2 font-mono text-[10px] lg:text-xs space-y-1">
                                <div className="flex flex-col-reverse">
                                    {logs.slice().reverse().map((l, i) => (
                                        <div key={i} className="text-slate-400 leading-tight border-l-2 border-slate-700 pl-2 py-0.5">{l}</div>
                                    ))}
                                </div>
                            </div>
                         </div>
                     </div>

                     {/* Right Sidebar: å®çŸ³é“¶è¡Œ (æ’‘æ»¡é«˜åº¦) */}
                     <div className="w-28 lg:w-32 xl:w-36 bg-[#0f172a] border-l border-slate-800 p-2 flex flex-col gap-1 z-10 shadow-xl shrink-0 h-full overflow-hidden">
                        <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 text-center shrink-0 border-b border-slate-800 pb-1">å®çŸ³é“¶è¡Œ</div>
                        <div className="flex-1 flex flex-col gap-1 justify-between min-h-0">
                            <button onClick={() => handleGemClick('gold')} disabled={bank.gold === 0 && !isReserving} className={`prevent-squish relative flex-1 rounded-lg lg:rounded-xl flex flex-col items-center justify-center border transition-all min-h-0 ${isReserving ? 'bg-yellow-500 border-yellow-300 ring-2 ring-yellow-400' : 'bg-yellow-900/10 border-yellow-900/30 opacity-80 hover:opacity-100 active:scale-95'}`}><GemToken type="gold" size="md" showCount={false} /><span className={`text-[10px] lg:text-xs font-bold mt-0.5 ${isReserving ? 'text-black' : 'text-yellow-700'}`}>å¿ƒçµå®çŸ³</span><span className={`absolute top-1 right-2 text-xs font-black ${isReserving ? 'text-black' : 'text-yellow-800'}`}>{bank.gold}</span></button>
                            {GEM_TYPES.map(type => (<button key={type} onClick={() => handleGemClick(type)} disabled={bank[type] === 0 || gameState !== 'playing'} className={`prevent-squish relative flex-1 rounded-lg lg:rounded-xl flex flex-col items-center justify-center transition-all group min-h-0 bg-slate-800/40 border border-slate-700 active:bg-slate-700 ${selectedGems.includes(type) ? 'ring-2 ring-emerald-500 bg-slate-800' : ''} ${bank[type] === 0 ? 'opacity-30 grayscale cursor-not-allowed' : ''}`}><GemToken type={type} size="md" showCount={false} /><span className="text-[10px] font-bold text-slate-400 mt-0.5 group-hover:text-white">{GEM_STYLES[type].label}</span><span className="absolute top-1 right-2 text-xs font-black text-slate-600 group-hover:text-slate-300">{bank[type]}</span>{selectedGems.filter(g => g === type).length > 0 && (<div className="absolute top-1 left-1 bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold shadow-lg border border-slate-900 z-10">{selectedGems.filter(g => g === type).length}</div>)}</button>))}
                        </div>
                        <div className="mt-1 space-y-1 shrink-0">{selectedGems.length > 0 ? (<><button onClick={confirmTakeGems} className="w-full py-2 bg-gradient-to-r from-emerald-600 to-green-500 text-white font-bold rounded-lg shadow-lg active:scale-95 transition-all text-xs">ç¡®è®¤</button><button onClick={() => setSelectedGems([])} className="w-full py-1 text-slate-500 text-[10px] font-bold uppercase tracking-wider hover:text-white">å–æ¶ˆ</button></>) : (<div className="p-2 rounded bg-slate-900/50 border border-slate-800 text-center"><p className="text-[10px] text-slate-500">è½®åˆ° <span className="text-amber-500 font-bold">{currentPlayer ? currentPlayer.name : ''}</span></p></div>)}</div>
                     </div>
                 </div>
              </div>

              <div className="h-28 lg:h-36 xl:h-44 bg-[#0f172a] border-t border-slate-800 grid grid-cols-2 divide-x divide-slate-800 z-30 shrink-0 shadow-2xl">
                 {bottomPlayers.map((p) => {
                     const isActive = p.id === currentPlayer.id;
                     const isSingleHuman = bottomPlayers.length === 1;
                     
                     // å•äººæ¨¡å¼ç‰¹æ®Šå¸ƒå±€
                     if (isSingleHuman) {
                         return (
                             <div key={p.id} className="col-span-2 flex w-full h-full relative bg-slate-900/50 shadow-[inset_0_0_30px_rgba(245,158,11,0.1)]">
                                {isActive && <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent shadow-[0_0_20px_rgba(245,158,11,0.8)] z-20"></div>}
                                {isActive && <div className="absolute top-0 right-0 bg-amber-500 text-amber-950 text-[10px] font-bold px-2 py-0.5 rounded-bl-lg shadow-md animate-pulse">å½“å‰å›åˆ</div>}
                                
                                {/* 1. å¤´åƒä¸åˆ†æ•° (Left) */}
                                <div className="w-24 lg:w-32 flex flex-col items-center justify-center p-2 border-r border-slate-800/50 gap-2 shrink-0">
                                   <div className="w-12 h-12 rounded-full border-2 border-amber-500 bg-amber-900/20 flex items-center justify-center shadow-lg text-white scale-110">
                                       {p.isComputer ? <BotIcon size={24}/> : (p.character === 'nick'?<NickIcon size={24}/>:<JudyIcon size={24}/>)}
                                   </div>
                                   <div className="font-bold text-base text-white">{p.name}</div>
                                   <div className="flex flex-col items-center bg-black/30 px-4 py-1 rounded-lg border border-amber-500/30"><div className="text-yellow-500 font-black text-2xl">{p.score}</div></div>
                                </div>

                                {/* 2. èµ„æºåŒº (Middle Left) */}
                                <div className="flex-1 flex flex-col border-r border-slate-800/50 max-w-md">
                                   <div className="flex-1 flex items-center justify-around px-2 border-b border-slate-800/50 bg-black/10">
                                      <div className="flex flex-col items-center"><GemToken type="gold" size="md" count={p.gems.gold} /></div>
                                      <div className="w-px h-8 bg-slate-700/30"></div>
                                      {GEM_TYPES.map(t => (<div key={t} className="flex flex-col items-center"><GemToken type={t} size="md" count={p.gems[t]} /></div>))}
                                   </div>
                                   <div className="flex-1 flex items-center justify-around px-2">
                                      {GEM_TYPES.map(t => (<div key={t}><BonusCardStack type={t} count={p.bonuses[t]} /></div>))}
                                   </div>
                                </div>

                                {/* 3. è´µæ—åŒº (Middle Narrow) */}
                                <div className="w-16 border-r border-slate-800/50 flex flex-col p-1 bg-black/10 items-center justify-start overflow-y-auto custom-scrollbar shrink-0">
                                   <div className="text-[8px] text-slate-500 font-bold uppercase mb-1">è´µæ—</div>
                                   {p.visitedNobles.length > 0 ? p.visitedNobles.map((n, i) => (<MiniNoble key={i} noble={n} />)) : (<div className="w-8 h-8 rounded border border-dashed border-slate-700 flex items-center justify-center opacity-30 mt-2"><Crown size={14} /></div>)}
                                </div>

                                {/* 4. é¢„ç•™å¡ç‰ŒåŒº (Right - Expanded) */}
                                <div className="flex-1 flex flex-col p-2 bg-black/20 relative">
                                   <div className="flex items-center gap-2 mb-1 opacity-60 text-[10px] font-bold uppercase tracking-wider text-slate-300"><Lock size={12} /> é¢„ç•™å¡ç‰‡ ({p.reserved.length}/3)</div>
                                   <div className="flex-1 flex gap-3 items-center justify-center h-full">
                                      {/* Slots */}
                                      {[0, 1, 2].map(i => {
                                          const card = p.reserved[i];
                                          return card ? (
                                              <div key={card.id} className="h-full aspect-[3/4] relative hover:-translate-y-1 transition-transform">
                                                  <Card 
                                                    card={card} 
                                                    customSizeClass="w-full h-full" 
                                                    canBuy={gameState === 'playing' && isActive && canAfford(p, card)} 
                                                    onBuy={(c) => handleBuyCard(c, true)} // Buy from reserved
                                                    isReservedView={true}
                                                  />
                                                  {/* Buy Button Overlay if affordable */}
                                                  {isActive && canAfford(p, card) && (
                                                      <div className="absolute -top-2 -right-2 bg-green-500 text-white rounded-full p-1 shadow-lg z-20 pointer-events-none animate-bounce"><div className="w-3 h-3 rounded-full bg-white"></div></div>
                                                  )}
                                              </div>
                                          ) : (
                                              <div key={i} className="h-full aspect-[3/4] rounded-lg border-2 border-dashed border-slate-700/50 bg-black/10 flex items-center justify-center">
                                                  <div className="text-slate-700 font-bold text-xs">ç©º</div>
                                              </div>
                                          );
                                      })}
                                   </div>
                                </div>
                             </div>
                         );
                     }

                     // å¤šäººæ¨¡å¼æ ‡å‡†å¸ƒå±€
                     return (
                      <div key={p.id} className={`flex transition-colors relative ${isActive ? 'bg-slate-900/50 -mt-[2px] z-10 box-content shadow-[inset_0_0_30px_rgba(245,158,11,0.1)]' : 'bg-[#0f172a]'} col-span-1`}>
                        {isActive && <div className="absolute top-0 left-0 w-full h-1 lg:h-1.5 bg-gradient-to-r from-transparent via-amber-500 to-transparent shadow-[0_0_20px_rgba(245,158,11,0.8)] z-20"></div>}
                        {isActive && <div className="absolute top-0 right-0 bg-amber-500 text-amber-950 text-[10px] font-bold px-2 py-0.5 rounded-bl-lg shadow-md animate-pulse">å½“å‰å›åˆ</div>}
                        <div className={`w-20 lg:w-24 xl:w-28 flex flex-col items-center justify-center p-1 border-r border-slate-800/50 gap-1 lg:gap-2 pl-8`}>
                           <div className={`w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center border-2 shadow-lg transition-transform ${isActive ? 'bg-amber-600 border-amber-400 text-white scale-110' : 'bg-slate-800 border-slate-700 text-slate-500'} overflow-hidden`}>{p.isComputer ? <BotIcon size={18}/> : (p.character === 'nick'?<NickIcon size={18}/>:<JudyIcon size={18}/>)}</div>
                           <div className="text-center"><div className={`font-bold text-xs lg:text-sm leading-none mb-0.5 ${isActive ? 'text-white' : 'text-slate-500'}`}>{p.name}</div></div>
                           <div className="flex flex-col items-center bg-black/20 p-1 rounded-lg w-full"><div className="text-yellow-500 font-black text-lg lg:text-xl">{p.score}</div></div>
                        </div>
                        <div className="w-10 lg:w-14 border-r border-slate-800/50 flex flex-col p-1 bg-black/10">
                           <div className="text-[8px] text-slate-600 font-bold uppercase mb-1 text-center">è´µæ— ({p.visitedNobles.length})</div>
                           <div className="flex-1 flex flex-col gap-1 items-center justify-start overflow-y-auto custom-scrollbar">{p.visitedNobles.length > 0 ? p.visitedNobles.map((n, i) => (<MiniNoble key={i} noble={n} />)) : (<div className="w-8 h-8 rounded border border-dashed border-slate-700 flex items-center justify-center opacity-30"><Crown size={14} /></div>)}</div>
                        </div>
                        <div className="flex-1 flex flex-col border-r border-slate-800/50">
                           <div className="flex-1 flex items-center px-1 lg:px-2 border-b border-slate-800/50 relative bg-black/10">
                              <div className="flex-1 flex justify-around items-center"><div className="flex flex-col items-center"><GemToken type="gold" size="sm" count={p.gems.gold} className="scale-90" /></div><div className="w-px h-6 bg-slate-700/30"></div>{GEM_TYPES.map(t => (<div key={t} className="flex flex-col items-center"><GemToken type={t} size="sm" count={p.gems[t]} className={`${p.gems[t] === 0 ? 'opacity-20 grayscale' : ''} scale-90`} /></div>))}</div>
                           </div>
                           <div className="flex-1 flex items-center px-1 lg:px-2 relative">
                              <div className="flex-1 flex justify-around items-center">{GEM_TYPES.map(t => (<div key={t} className={`${p.bonuses[t] === 0 ? 'opacity-10 grayscale' : ''}`}><BonusCardStack type={t} count={p.bonuses[t]} /></div>))}</div>
                           </div>
                        </div>
                        <div className="w-20 lg:w-28 flex flex-col p-1 lg:p-2 bg-black/20 relative group cursor-pointer hover:bg-white/5 transition-colors" onClick={() => setViewingReservedPlayer(p)}>
                           <div className="flex items-center gap-1 mb-1 opacity-50 text-[8px] font-bold uppercase tracking-wider text-slate-400 text-center justify-center"><Grip size={10} /> é¢„ç•™ ({p.reserved.length})</div>
                           <div className="flex-1 grid grid-cols-2 grid-rows-2 gap-1 items-center justify-center">
                              {p.reserved.map((c) => {
                                const style = GEM_STYLES[c.bonus];
                                return (
                                    <div key={c.id} className={`w-full h-full rounded border-2 flex items-center justify-center relative shadow-md transition-transform ${style.cardBorder} ${style.cardBg}`}>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center opacity-80">
                                            <div className="scale-50"><GemIconSVG type={c.bonus} className={style.iconFill} /></div>
                                        </div>
                                        <div className="absolute bottom-0.5 right-1 font-black text-white text-[8px] drop-shadow-md text-stroke-black">{c.points || ''}</div>
                                        {canAfford(p, c) && <div className="absolute top-0 left-0 w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse shadow-lg"></div>}
                                    </div>
                                );
                              })}
                              {Array(4 - p.reserved.length).fill(0).map((_, i) => (<div key={i} className={`w-full h-full rounded border border-dashed border-slate-800/50 bg-black/10 flex items-center justify-center ${i + p.reserved.length >= 3 ? 'opacity-20 bg-red-900/10' : ''}`}>{i + p.reserved.length >= 3 ? <Lock size={10} className="text-slate-700" /> : null}</div>))}
                           </div>
                        </div>
                      </div>
                     );
                 })}
              </div>

              {viewingReservedPlayer && (
                  <ReservedCardsModal 
                      player={viewingReservedPlayer} 
                      currentPlayer={currentPlayer} 
                      onClose={() => setViewingReservedPlayer(null)}
                      onBuy={handleBuyCard}
                  />
              )}

              {gameState === 'end' && (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm safe-top-padding">
                  <div className="bg-slate-900 border-2 border-amber-500 rounded-2xl p-6 xl:p-10 max-w-lg w-full text-center shadow-[0_0_100px_rgba(245,158,11,0.2)]">
                    <Trophy size={60} className="text-amber-500 mx-auto mb-4" />
                    <h2 className="text-3xl xl:text-5xl font-black text-white mb-2">{winner?.name} è·èƒœï¼</h2>
                    <div className="text-xl xl:text-2xl text-amber-400 mb-6 font-bold">æ€»å¾—åˆ†: {winner?.score}</div>
                    
                    <div className="flex gap-4 mt-6">
                        <button onClick={() => setGameState('setup')} className="flex-1 py-3 bg-slate-700 hover:bg-slate-600 border-2 border-slate-500 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform">
                            è¿”å›ä¸»é¡µ
                        </button>
                        <button onClick={startSetup} className="flex-1 py-3 bg-gradient-to-r from-amber-600 to-yellow-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform">
                            å†æ¥ä¸€å±€
                        </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SplendorGame />);
    </script>
</body>
</html>
