<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Splendor">
    
    <title>ç’€ç’¨å®çŸ³ (Splendor)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #0f172a;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        #root {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .prevent-squish { flex-shrink: 0; }

        /* å¡ç‰Œçº¹ç† */
        .pattern-stripes { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 10px, transparent 10px, transparent 20px); }
        .pattern-dots { background-image: radial-gradient(rgba(255,255,255,0.15) 1.5px, transparent 1.5px); background-size: 15px 15px; }
        .pattern-grid { background-image: linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px); background-size: 20px 20px; }
        .pattern-checkers { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%, rgba(255,255,255,0.08)), repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%, rgba(255,255,255,0.08)); background-position: 0 0, 10px 10px; background-size: 20px 20px; }
        .pattern-radial-dark { background-image: radial-gradient(circle at center, rgba(0,0,0,0.05) 0%, transparent 70%); }

        /* æ–‡å­—æè¾¹æ•ˆæœ */
        .text-stroke-black {
            -webkit-text-stroke: 1px rgba(0, 0, 0, 0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            paint-order: stroke fill;
        }
        .text-stroke-black-strong {
            -webkit-text-stroke: 2px rgba(0, 0, 0, 0.8);
            text-shadow: 0 1px 2px rgba(0,0,0,1);
            paint-order: stroke fill;
        }
        
        /* åŠ¨ç”» */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10% { opacity: 1; transform: translate(-50%, 0); }
            90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        .animate-notification {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        
        @keyframes roll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            100% { transform: rotateX(720deg) rotateY(720deg); }
        }
        .dice-roll { animation: roll 0.5s ease-out; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- å°ºå¯¸å¸¸é‡ ---
        const CARD_SIZE_CLASSES = "w-20 h-28 sm:w-24 sm:h-32 lg:w-28 lg:h-40 xl:w-36 xl:h-52";

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconBase = ({ children, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Crown = (p) => <IconBase {...p}><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Lock = (p) => <IconBase {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></IconBase>;
        const ScrollText = (p) => <IconBase {...p}><path d="M15 12h-5"/><path d="M15 8h-5"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3"/></IconBase>;
        const Grip = (p) => <IconBase {...p}><circle cx="12" cy="5" r="1"/><circle cx="19" cy="5" r="1"/><circle cx="5" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/><circle cx="12" cy="19" r="1"/><circle cx="19" cy="19" r="1"/><circle cx="5" cy="19" r="1"/></IconBase>;
        const Trophy = (p) => <IconBase {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Undo2 = (p) => <IconBase {...p}><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></IconBase>;
        const Dices = (p) => <IconBase {...p}><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></IconBase>;

        const Diamond = (p) => <IconBase {...p}><path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0l-7.59 7.59Z"/></IconBase>;
        const Hexagon = (p) => <IconBase {...p}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></IconBase>;
        const Square = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="3" rx="2" /></IconBase>;
        const Circle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10" /></IconBase>;
        const Triangle = (p) => <IconBase {...p}><path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3l-8-14z"/></IconBase>;
        const Sparkles = (p) => <IconBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275-1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></IconBase>;

        // --- æ ·å¼é…ç½® ---
        const GEM_TYPES = ['emerald', 'sapphire', 'ruby', 'diamond', 'onyx'];

        const GEM_STYLES = {
          emerald: { 
            tokenGradient: 'bg-emerald-600', tokenBorder: 'border-emerald-400',
            cardBg: 'bg-emerald-900', cardBorder: 'border-emerald-500/50',
            patternClass: 'pattern-dots', accentColor: 'text-emerald-500', shapeFill: 'text-emerald-500/20',
            costBg: 'bg-emerald-700/80', costColor: 'bg-emerald-500', textColor: 'text-emerald-600',
            pointColor: 'text-white text-stroke-black',
            iconFill: 'fill-emerald-500 stroke-black stroke-[1.5px]',
            label: 'ç»¿å®çŸ³' 
          },
          sapphire: { 
            tokenGradient: 'bg-blue-600', tokenBorder: 'border-blue-400',
            cardBg: 'bg-blue-900', cardBorder: 'border-blue-500/50',
            patternClass: 'pattern-grid', accentColor: 'text-blue-500', shapeFill: 'text-blue-500/20',
            costBg: 'bg-blue-700/80', costColor: 'bg-blue-500', textColor: 'text-blue-600',
            pointColor: 'text-white text-stroke-black',
            iconFill: 'fill-blue-500 stroke-black stroke-[1.5px]',
            label: 'è“å®çŸ³' 
          },
          ruby: { 
            tokenGradient: 'bg-red-600', tokenBorder: 'border-red-400',
            cardBg: 'bg-rose-900', cardBorder: 'border-red-500/50',
            patternClass: 'pattern-stripes', accentColor: 'text-rose-500', shapeFill: 'text-rose-500/20',
            costBg: 'bg-rose-700/80', costColor: 'bg-rose-500', textColor: 'text-rose-600',
            pointColor: 'text-white text-stroke-black',
            iconFill: 'fill-rose-500 stroke-black stroke-[1.5px]',
            label: 'çº¢å®çŸ³' 
          },
          diamond: { 
            tokenGradient: 'bg-slate-300', tokenBorder: 'border-white',
            cardBg: 'bg-slate-200', cardBorder: 'border-white/80',
            patternClass: 'pattern-radial-dark', accentColor: 'text-slate-500', shapeFill: 'text-black/10',
            // è°ƒæ•´CostèƒŒæ™¯é¢œè‰²
            costBg: 'bg-slate-300/90', costColor: 'bg-slate-200', textColor: 'text-slate-600',
            pointColor: 'text-white text-stroke-black',
            iconFill: 'fill-white stroke-black stroke-[1.5px]',
            label: 'é’»çŸ³' 
          },
          onyx: { 
            tokenGradient: 'bg-zinc-700', tokenBorder: 'border-zinc-500',
            cardBg: 'bg-zinc-700', cardBorder: 'border-zinc-400/50',
            patternClass: 'pattern-checkers', accentColor: 'text-zinc-400', shapeFill: 'text-white/10',
            costBg: 'bg-zinc-600/90', costColor: 'bg-zinc-500', textColor: 'text-stone-800',
            pointColor: 'text-white text-stroke-black',
            iconFill: 'fill-zinc-800 stroke-black stroke-[1.5px]',
            label: 'é»‘æ›œçŸ³' 
          },
          gold: { 
            tokenGradient: 'bg-yellow-500', tokenBorder: 'border-yellow-200',
            textColor: 'text-amber-600',
            label: 'é»„é‡‘' 
          },
        };

        const LEVEL_CONFIG = {
          1: { dotColor: 'text-emerald-400', borderColor: 'border-emerald-500/30', bg: 'bg-emerald-900/20' },
          2: { dotColor: 'text-yellow-400', borderColor: 'border-yellow-500/30', bg: 'bg-yellow-900/20' },
          3: { dotColor: 'text-blue-400', borderColor: 'border-blue-500/30', bg: 'bg-blue-900/20' },
        };

        const POINTS_TO_WIN = 15;
        const MAX_GEMS = 10;
        const MAX_RESERVED = 3;

        // --- çœŸå®å¡ç‰Œæ•°æ® (ç®€åŒ–ç‰ˆï¼Œç¡®ä¿å¹³è¡¡) ---
        // æ ¼å¼: [åˆ†æ•°, å®çŸ³å¥–åŠ±ç±»å‹, {è´¹ç”¨}]
        // é¢œè‰²æ˜ å°„: 0:emerald, 1:sapphire, 2:ruby, 3:diamond, 4:onyx
        const REAL_CARDS_LV1 = [
            [0,0,{1:1,2:1,3:1,4:1}], [0,0,{1:1,2:2,3:1,4:1}], [0,0,{1:2,2:2,4:1}], [0,0,{0:1,1:3,2:1}], [0,0,{2:1,4:2}], [0,0,{0:2,4:2}], [0,0,{0:3}], [1,0,{1:4}],
            [0,1,{0:1,2:1,3:1,4:1}], [0,1,{0:1,2:2,3:1,4:1}], [0,1,{0:1,2:2,3:2}], [0,1,{2:1,3:3,4:1}], [0,1,{2:2,3:1}], [0,1,{0:2,2:2}], [0,1,{1:3}], [1,1,{2:4}],
            [0,2,{0:1,1:1,3:1,4:1}], [0,2,{0:1,1:2,3:1,4:1}], [0,2,{0:1,1:1,3:2,4:1}], [0,2,{0:3,1:1,4:1}], [0,2,{0:2,1:1}], [0,2,{1:2,3:2}], [0,2,{2:3}], [1,2,{4:4}],
            [0,3,{0:1,1:1,2:1,4:1}], [0,3,{0:1,1:1,2:2,4:1}], [0,3,{0:1,1:2,2:2}], [0,3,{0:1,1:1,2:3}], [0,3,{0:2,4:1}], [0,3,{0:2,1:2}], [0,3,{3:3}], [1,3,{0:4}],
            [0,4,{0:1,1:1,2:1,3:1}], [0,4,{0:1,1:1,2:1,3:2}], [0,4,{0:1,1:2,2:1,3:1}], [0,4,{0:1,2:1,3:3}], [0,4,{1:2,2:1}], [0,4,{2:2,3:2}], [0,4,{4:3}], [1,4,{3:4}]
        ];
        const REAL_CARDS_LV2 = [
            [1,0,{0:2,1:3,2:3}], [1,0,{0:2,1:2,2:3}], [2,0,{1:5}], [2,0,{0:4,2:1,4:2}], [2,0,{1:5,2:3}], [3,0,{3:6}],
            [1,1,{1:2,2:3,3:3}], [1,1,{0:2,1:2,2:3}], [2,1,{2:5}], [2,1,{0:2,1:1,3:4}], [2,1,{2:5,3:3}], [3,1,{2:6}],
            [1,2,{2:2,3:3,4:3}], [1,2,{2:2,3:2,4:3}], [2,2,{4:5}], [2,2,{0:4,3:2,4:1}], [2,2,{0:3,4:5}], [3,2,{0:6}],
            [1,3,{0:3,1:3,2:2}], [1,3,{0:3,1:3,4:2}], [2,3,{0:5}], [2,3,{0:1,1:4,2:2}], [2,3,{0:5,1:3}], [3,3,{1:6}],
            [1,4,{0:3,1:2,2:3}], [1,4,{0:3,3:3,4:2}], [2,4,{3:5}], [2,4,{1:1,2:4,3:2}], [2,4,{3:5,4:3}], [3,4,{4:6}]
        ];
        const REAL_CARDS_LV3 = [
            [3,0,{0:3,1:3,2:5,3:3}], [4,0,{3:7}], [4,0,{0:3,1:6,2:3}], [5,0,{0:3,1:7}],
            [3,1,{0:3,1:3,2:3,4:5}], [4,1,{4:7}], [4,1,{0:3,1:3,2:6}], [5,1,{1:3,2:7}],
            [3,2,{0:5,1:3,2:3,4:3}], [4,2,{0:7}], [4,2,{0:6,1:3,4:3}], [5,2,{2:3,3:7}],
            [3,3,{0:3,2:3,3:3,4:5}], [4,3,{1:7}], [4,3,{0:3,3:6,4:3}], [5,3,{0:7,3:3}],
            [3,4,{0:3,1:5,3:3,4:3}], [4,4,{2:7}], [4,4,{1:3,2:3,4:6}], [5,4,{2:7,4:3}]
        ];
        const REAL_NOBLES = [
            {points:3, req:{0:4, 1:4}}, {points:3, req:{0:4, 2:4}}, {points:3, req:{0:4, 3:4}}, {points:3, req:{0:4, 4:4}},
            {points:3, req:{1:4, 2:4}}, {points:3, req:{1:4, 3:4}}, {points:3, req:{1:4, 4:4}},
            {points:3, req:{2:4, 3:4}}, {points:3, req:{2:4, 4:4}}, {points:3, req:{3:4, 4:4}},
            {points:3, req:{0:3, 2:3, 3:3}}, {points:3, req:{0:3, 1:3, 4:3}}
        ];

        // --- é€»è¾‘å‡½æ•° ---
        const shuffleArray = (array) => {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        };

        const mapCost = (costObj) => {
            const res = {};
            for(let k in costObj) res[GEM_TYPES[k]] = costObj[k];
            return res;
        };

        const mapRealCards = (realData, level) => {
            return realData.map((d, i) => ({
                id: `l${level}-${i}`,
                level,
                points: d[0],
                bonus: GEM_TYPES[d[1]],
                cost: mapCost(d[2])
            }));
        };

        const generateDeck = () => {
            const d1 = shuffleArray(mapRealCards(REAL_CARDS_LV1, 1));
            const d2 = shuffleArray(mapRealCards(REAL_CARDS_LV2, 2));
            const d3 = shuffleArray(mapRealCards(REAL_CARDS_LV3, 3));
            return { 1: d1, 2: d2, 3: d3 };
        };

        const generateNobles = () => {
            const mapped = REAL_NOBLES.map((n, i) => ({ id: `noble-${i}`, points: n.points, req: mapCost(n.req) }));
            return shuffleArray(mapped).slice(0, 3);
        };

        // --- å­ç»„ä»¶ ---
        const GemIconSVG = ({ type, size = "100%", className = "" }) => {
          if (type === 'diamond') return <Diamond size={size} className={className} strokeWidth={2} />;
          if (type === 'emerald') return <Hexagon size={size} className={className} strokeWidth={2} />;
          if (type === 'ruby') return <Square size={size} className={className} strokeWidth={2} />;
          if (type === 'sapphire') return <Triangle size={size} className={`${className} rotate-180`} strokeWidth={2} />;
          if (type === 'onyx') return <Circle size={size} className={className} strokeWidth={2} />;
          if (type === 'gold') return <Sparkles size={size} className={className} strokeWidth={2} />;
          return null;
        };

        const GemToken = ({ type, size = 'md', className = "", count, showCount = true }) => {
          const sizeClasses = {
            sm: 'w-5 h-5 lg:w-6 lg:h-6 xl:w-7 xl:h-7 text-[10px] lg:text-xs',
            md: 'w-7 h-7 lg:w-9 lg:h-9 xl:w-10 xl:h-10 text-xs lg:text-sm',
            lg: 'w-10 h-10 lg:w-12 lg:h-12 xl:w-16 xl:h-16 text-base lg:text-lg',
            xl: 'w-14 h-14 lg:w-16 lg:h-16 xl:w-20 xl:h-20 text-lg lg:text-xl'
          };
          const style = GEM_STYLES[type];
          return (
            <div className={`prevent-squish relative rounded-full flex items-center justify-center font-bold border-2 ${style.tokenGradient} shadow-md border-opacity-50 ${style.tokenBorder} ${type === 'diamond' ? 'text-slate-800' : 'text-white'} ${sizeClasses[size]} ${className} transition-transform active:translate-y-1 active:shadow-none shrink-0 shadow-black/30`}> 
              <div className={`absolute top-0 left-0 w-full h-1/2 rounded-t-full pointer-events-none ${type === 'diamond' ? 'bg-white/50' : 'bg-white/20'}`}></div>
              <div className="w-[60%] h-[60%] flex items-center justify-center fill-current"><GemIconSVG type={type} /></div>
              {showCount && count !== undefined && (<span className="absolute -bottom-1 -right-1 bg-black text-white text-[9px] lg:text-[10px] min-w-[16px] h-4 lg:h-5 flex items-center justify-center rounded-full border border-slate-600 shadow-md z-10 px-1">{count}</span>)}
            </div>
          );
        };

        const BonusCardStack = ({ type, count }) => {
          const style = GEM_STYLES[type];
          return (
            <div className={`prevent-squish relative w-8 h-12 lg:w-10 lg:h-14 xl:w-12 xl:h-16 rounded-md border-2 flex items-center justify-center shadow-md transition-transform ${style.cardBg} ${style.cardBorder} group overflow-hidden`}>
               <div className={`absolute inset-0 opacity-30 ${style.patternClass}`}></div>
               {count > 1 && <div className={`absolute top-0.5 right-0.5 w-full h-full rounded border border-inherit bg-inherit opacity-80 -z-10`}></div>}
               {count > 2 && <div className={`absolute top-1 right-1 w-full h-full rounded border border-inherit bg-inherit opacity-60 -z-20`}></div>}
               <div className={`drop-shadow-md z-10`}><GemIconSVG type={type} size="60%" className={style.iconFill} /></div>
               <div className={`absolute inset-0 flex items-center justify-center z-20`}>
                 <span className={`font-black text-white text-stroke-black text-base lg:text-lg xl:text-xl`}>{count}</span>
               </div>
            </div>
          );
        };

        const MiniGem = ({ type }) => {
          const colors = { emerald: 'bg-emerald-500 border-emerald-700', sapphire: 'bg-blue-600 border-blue-800', ruby: 'bg-red-600 border-red-800', diamond: 'bg-slate-200 border-slate-400', onyx: 'bg-slate-800 border-black', gold: 'bg-yellow-400 border-yellow-600' };
          return <div className={`w-2 h-2 lg:w-2.5 lg:h-2.5 rounded-full border ${colors[type]} shadow-sm`}></div>;
        };

        const Card = ({ card, canBuy, onBuy, isReserving, isReservedView = false, inModal = false }) => {
          const style = GEM_STYLES[card.bonus];
          const canReserve = isReserving && !isReservedView;
          
          return (
            <div 
              className={`prevent-squish relative group flex flex-col justify-between ${inModal ? 'w-48 h-64 scale-100' : CARD_SIZE_CLASSES} rounded-lg lg:rounded-xl transition-all duration-300 ${style.cardBg} border-2 overflow-hidden shadow-xl 
              ${canReserve ? 'ring-4 ring-yellow-400 cursor-pointer animate-pulse z-20' : ''}
              ${canBuy && !isReserving ? 'ring-2 lg:ring-4 ring-green-400/80 cursor-pointer -translate-y-1 lg:-translate-y-2 shadow-green-900/50 z-10' : `${style.cardBorder} ${!isReserving ? 'hover:z-10' : ''}`}`}
              onClick={() => {
                  if (canReserve) onBuy(card, 'reserve');
                  else if (canBuy) onBuy(card, 'buy');
              }}
            >
              <div className={`absolute inset-0 opacity-30 pointer-events-none ${style.patternClass}`}></div>
              <div className={`absolute inset-0 flex items-center justify-center pointer-events-none transition-transform duration-500 group-hover:scale-110 ${style.shapeFill}`}>
                  <GemIconSVG type={card.bonus} size={100} className="fill-current" />
              </div>
              
              <div className={`flex justify-between items-start p-2 lg:p-3 z-10 relative`}>
                <div className={`text-3xl lg:text-4xl xl:text-5xl font-serif font-black ${style.pointColor} drop-shadow-[0_2px_4px_rgba(0,0,0,0.5)] leading-none mt-0.5 lg:mt-1 ml-0.5 lg:ml-1 filter`}>{card.points > 0 ? card.points : ''}</div>
                <div className={`w-7 h-7 lg:w-9 lg:h-9 xl:w-10 xl:h-10 rounded-full flex items-center justify-center shadow-xl border-2 bg-white border-white`}>
                   <GemIconSVG type={card.bonus} size={20} className={`${style.iconFill} lg:scale-110`} />
                </div>
              </div>

              {canReserve && <div className="absolute inset-0 bg-yellow-500/10 flex items-center justify-center pointer-events-none"><Lock size={32} className="text-yellow-200 drop-shadow-md" /></div>}

              <div className={`mt-auto p-1 lg:p-1.5 flex flex-col gap-1 backdrop-blur-md border-t border-white/10 z-10 rounded-b-lg ${style.costBg}`}>
                <div className="flex flex-nowrap gap-0.5 lg:gap-1.5 items-end justify-center min-h-[20px] lg:min-h-[24px]">
                  {Object.entries(card.cost).map(([type, amount]) => (
                    <div key={type} className={`flex items-center justify-center w-5 h-5 lg:w-6 lg:h-6 xl:w-7 xl:h-7 rounded-full border-2 ${GEM_STYLES[type].tokenGradient} ${GEM_STYLES[type].tokenBorder} ${type === 'diamond' ? 'text-slate-900' : 'text-white'} text-[10px] lg:text-xs xl:text-sm font-black shadow-sm`}>{amount}</div>
                  ))}
                </div>
              </div>
              <div className={`absolute top-1/2 -translate-y-1/2 left-1 flex flex-col gap-1 opacity-30`}>{Array(card.level).fill(0).map((_, i) => (<div key={i} className="w-1 h-1 lg:w-1.5 lg:h-1.5 rounded-full bg-white shadow"></div>))}</div>
            </div>
          );
        };

        const NobleTile = ({ noble }) => (
          <div className={`prevent-squish w-20 h-28 lg:w-24 lg:h-32 xl:w-28 xl:h-36 rounded-lg border-4 border-amber-500/50 flex flex-col items-center p-2 lg:p-2.5 shadow-xl relative overflow-hidden shrink-0 bg-gradient-to-br from-amber-100 via-yellow-100 to-amber-200`}>
            <div className="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] mix-blend-overlay"></div>
            <div className="absolute top-0 right-0 p-1 opacity-20"><Crown size={50} className="text-amber-500" /></div>
            <div className="relative z-10 w-full h-full flex flex-col justify-between">
              <div className="text-2xl lg:text-3xl xl:text-4xl font-serif font-black text-amber-900 self-start leading-none drop-shadow-sm">{noble.points}</div>
              <div className="flex flex-col gap-0.5 lg:gap-1 self-end w-full pl-1 lg:pl-2">
                {Object.entries(noble.req).map(([type, amt]) => (
                  <div key={type} className="flex justify-between items-center bg-white/70 rounded px-1.5 lg:px-2 h-4 lg:h-5 shadow-sm border border-amber-200/50"><MiniGem type={type} /><span className="text-[10px] lg:text-xs font-bold text-amber-950">{amt}</span></div>
                ))}
              </div>
            </div>
          </div>
        );

        const MiniNoble = ({ noble }) => (
           <div className="prevent-squish w-10 h-10 lg:w-12 lg:h-12 xl:w-14 xl:h-14 rounded border-2 border-amber-300 bg-gradient-to-br from-amber-100 to-amber-300 shadow-md flex items-center justify-center relative group cursor-help shrink-0">
              <div className="absolute top-0 left-0 text-[10px] lg:text-xs font-black text-amber-900 p-0.5 leading-none">{noble.points}</div>
              <Crown size={20} className="text-amber-600 opacity-50" />
           </div>
        );

        const Notification = ({ msg, type = 'error' }) => (
            <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[60] animate-notification pointer-events-none">
                <div className={`${type === 'success' ? 'bg-amber-500/90 border-amber-400' : 'bg-red-500/90 border-red-400'} backdrop-blur text-white px-6 py-4 rounded-xl shadow-2xl border-2 flex items-center gap-3`}>
                    {type === 'success' ? <Crown size={32} className="text-white shrink-0" strokeWidth={2.5}/> : <AlertCircle size={32} className="text-white shrink-0" strokeWidth={2.5}/>}
                    <span className="font-bold text-lg">{msg}</span>
                </div>
            </div>
        );

        const DiceRollModal = ({ onRollComplete }) => {
            const [rolling, setRolling] = useState(false);
            const [results, setResults] = useState([null, null]);
            const [winner, setWinner] = useState(null);

            const roll = () => {
                setRolling(true);
                let p1, p2;
                do {
                    p1 = Math.floor(Math.random() * 6) + 1;
                    p2 = Math.floor(Math.random() * 6) + 1;
                } while (p1 === p2);

                setTimeout(() => {
                    setResults([p1, p2]);
                    setWinner(p1 > p2 ? 0 : 1);
                    setRolling(false);
                    setTimeout(() => {
                        onRollComplete(p1 > p2 ? 0 : 1);
                    }, 2000);
                }, 1000);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 border-2 border-amber-500 rounded-2xl p-8 max-w-md w-full text-center shadow-2xl">
                        <h2 className="text-2xl font-bold text-white mb-6">äº‰å¤ºå…ˆæ‰‹</h2>
                        <div className="flex justify-around mb-8">
                            <div className="flex flex-col items-center gap-2">
                                <div className="text-amber-400 font-bold">ç©å®¶ 1</div>
                                <div className={`w-20 h-20 bg-slate-700 rounded-xl flex items-center justify-center text-4xl font-black border-2 border-slate-600 ${rolling ? 'animate-bounce' : ''}`}>
                                    {rolling ? '?' : (results[0] || '-')}
                                </div>
                            </div>
                            <div className="flex items-center text-slate-500 font-bold">VS</div>
                            <div className="flex flex-col items-center gap-2">
                                <div className="text-blue-400 font-bold">ç©å®¶ 2</div>
                                <div className={`w-20 h-20 bg-slate-700 rounded-xl flex items-center justify-center text-4xl font-black border-2 border-slate-600 ${rolling ? 'animate-bounce' : ''} animation-delay-100`}>
                                    {rolling ? '?' : (results[1] || '-')}
                                </div>
                            </div>
                        </div>
                        {winner === null ? (
                            <button onClick={roll} disabled={rolling} className="w-full py-3 bg-gradient-to-r from-amber-600 to-yellow-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform disabled:opacity-50 disabled:cursor-not-allowed">
                                {rolling ? 'æŠ•æ·ä¸­...' : 'æ·éª°å­'}
                            </button>
                        ) : (
                            <div className="text-xl font-bold text-green-400 animate-pulse">
                                {winner === 0 ? 'ç©å®¶ 1' : 'ç©å®¶ 2'} å…ˆæ‰‹ï¼
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- é¢„ç•™å¡æ¨¡æ€æ¡† ---
        const ReservedCardsModal = ({ player, currentPlayer, onClose, onBuy }) => {
          return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={onClose}>
                <div className="bg-slate-900 border-2 border-slate-700 rounded-2xl w-full max-w-2xl p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><X size={24}/></button>
                    <h2 className="text-2xl font-bold text-white mb-6 flex items-center gap-2"><Lock className="text-yellow-500"/> {player.name} çš„é¢„ç•™å¡ç‰‡</h2>
                    
                    {player.reserved.length === 0 ? (
                        <div className="text-center py-12 text-slate-500 italic">æš‚æ— é¢„ç•™å¡ç‰‡</div>
                    ) : (
                        <div className="flex flex-wrap gap-6 justify-center">
                            {player.reserved.map(card => {
                                const canBuy = player.id === currentPlayer.id && onBuy && onBuy(card, 'buy', true); // check only
                                return (
                                    <div key={card.id} className="flex flex-col gap-3 items-center">
                                        <Card card={card} inModal={true} />
                                        {player.id === currentPlayer.id ? (
                                            <button 
                                                onClick={() => onBuy(card, 'buy')}
                                                disabled={!canBuy}
                                                className={`px-4 py-2 rounded-full font-bold text-sm transition-all ${canBuy ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg active:scale-95' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}
                                            >
                                                {canBuy ? 'è´­ä¹°' : 'èµ„æºä¸è¶³'}
                                            </button>
                                        ) : (
                                            <div className="text-xs text-slate-500 font-bold uppercase tracking-wider">ä»…æŸ¥çœ‹</div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            </div>
          );
        };

        // --- ä¸»æ¸¸æˆç»„ä»¶ ---
        function SplendorGame() {
          const [gameState, setGameState] = useState('setup'); // setup, diceroll, playing, end
          const [deck, setDeck] = useState(null);
          const [board, setBoard] = useState({ 1: [], 2: [], 3: [] });
          const [nobles, setNobles] = useState([]);
          const [bank, setBank] = useState({});
          const [players, setPlayers] = useState([]);
          const [turn, setTurn] = useState(0);
          const [selectedGems, setSelectedGems] = useState([]);
          const [logs, setLogs] = useState([]);
          const [winner, setWinner] = useState(null);
          
          // History for undo
          const [history, setHistory] = useState([]);

          const [viewingReservedPlayer, setViewingReservedPlayer] = useState(null);
          const [notification, setNotification] = useState(null);
          const [notifType, setNotifType] = useState('error');
          const [isReserving, setIsReserving] = useState(false);
          const logsEndRef = useRef(null);

          const currentPlayerIndex = turn % 2;
          const currentPlayer = players[currentPlayerIndex];

          const showNotification = (msg, type = 'error') => {
              setNotification(msg);
              setNotifType(type);
              setTimeout(() => setNotification(null), 3000);
          };

          const saveState = () => {
              setHistory(prev => [...prev, JSON.stringify({
                  deck, board, nobles, bank, players, turn, logs
              })]);
          };

          const undo = () => {
              if (history.length === 0) return;
              const lastState = JSON.parse(history[history.length - 1]);
              setDeck(lastState.deck);
              setBoard(lastState.board);
              setNobles(lastState.nobles);
              setBank(lastState.bank);
              setPlayers(lastState.players);
              setTurn(lastState.turn);
              setLogs(lastState.logs);
              setHistory(prev => prev.slice(0, -1));
              setSelectedGems([]);
              setIsReserving(false);
              showNotification("å·²æ’¤é”€ä¸Šä¸€æ­¥æ“ä½œ", 'success');
          };

          const initGame = () => {
            setGameState('diceroll');
          };

          const startGame = (startingPlayerIndex) => {
            const newDeck = generateDeck();
            const newNobles = generateNobles();
            const newBoard = { 1: newDeck[1].splice(0, 4), 2: newDeck[2].splice(0, 4), 3: newDeck[3].splice(0, 4) };
            const initialBank = { emerald: 4, sapphire: 4, ruby: 4, diamond: 4, onyx: 4, gold: 5 };
            
            setDeck(newDeck);
            setBoard(newBoard);
            setNobles(newNobles);
            setBank(initialBank);
            setPlayers([
              { id: 0, name: "ç©å®¶ 1", gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] },
              { id: 1, name: "ç©å®¶ 2", gems: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0, gold:0 }, bonuses: { emerald:0, sapphire:0, ruby:0, diamond:0, onyx:0 }, score: 0, reserved: [], visitedNobles: [] },
            ]);
            setTurn(startingPlayerIndex); 
            setLogs(["æ¸¸æˆå¼€å§‹ï¼"]); 
            setSelectedGems([]); 
            setWinner(null); 
            setHistory([]);
            setGameState('playing');
          };

          const addLog = (msg) => setLogs(prev => [...prev, msg].slice(-20)); // ä¿ç•™æœ€å20æ¡
          const totalGems = (player) => Object.values(player.gems).reduce((a, b) => a + b, 0);

          useEffect(() => {
              logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
          }, [logs]);

          const canAfford = (player, card) => {
            let missing = 0;
            for (const [type, cost] of Object.entries(card.cost)) {
              const discount = player.bonuses[type];
              const available = player.gems[type];
              const costAfterDiscount = Math.max(0, cost - discount);
              if (available < costAfterDiscount) missing += (costAfterDiscount - available);
            }
            return player.gems.gold >= missing;
          };

          const getAffordCost = (player, card) => {
            let payment = { emerald: 0, sapphire: 0, ruby: 0, diamond: 0, onyx: 0, gold: 0 };
            let goldNeeded = 0;
            for (const [type, cost] of Object.entries(card.cost)) {
              const discount = player.bonuses[type];
              const actualCost = Math.max(0, cost - discount);
              const paidFromGems = Math.min(player.gems[type], actualCost);
              payment[type] = paidFromGems;
              goldNeeded += (actualCost - paidFromGems);
            }
            payment.gold = goldNeeded;
            return payment;
          };

          const handleGemClick = (type) => {
            if (type === 'gold') {
                if (bank.gold <= 0) { showNotification("é»„é‡‘å·²è¢«æ‹¿å…‰", 'error'); return; }
                if (currentPlayer.reserved.length >= MAX_RESERVED) { showNotification("é¢„ç•™ä½å·²æ»¡", 'error'); return; }
                setIsReserving(!isReserving);
                setSelectedGems([]);
                return;
            }
            if (isReserving) setIsReserving(false);

            // Gem Logic with Deselect capability
            const countCurrent = selectedGems.filter(g => g === type).length;
            const countTotal = selectedGems.length;

            if (countCurrent === 2) {
                // Was double, clear it
                setSelectedGems([]);
                return;
            }

            if (countCurrent === 1) {
                // Has 1 of this type
                if (countTotal > 1) {
                    // [A, B] -> Click A -> [B] (Deselect A)
                    setSelectedGems(selectedGems.filter(g => g !== type));
                    return;
                }
                
                // [A] -> Click A
                if (countTotal === 1) {
                    // Try to make it double [A, A]
                    if (bank[type] >= 4) {
                        setSelectedGems([type, type]);
                    } else {
                        // Cannot double, so just deselect
                        setSelectedGems([]);
                    }
                    return;
                }
            }

            // Case: 0 of this type. Adding new.
            if (bank[type] <= 0) { showNotification("è¯¥å®çŸ³å·²è¢«æ‹¿å…‰", 'error'); return; }
            
            // Check rules
            const hasDouble = new Set(selectedGems).size !== selectedGems.length;
            if (hasDouble) {
                showNotification("å·²æ‹¿åŒè‰²å®çŸ³ï¼Œä¸èƒ½å†æ‹¿å…¶ä»–", 'error');
                return;
            }
            
            if (countTotal >= 3) {
                showNotification("æœ€å¤šåªèƒ½æ‹¿3ä¸ªå®çŸ³", 'error');
                return;
            }

            // Add it
            setSelectedGems([...selectedGems, type]);
          };

          const confirmTakeGems = () => {
            if (selectedGems.length === 0) return;
            if (totalGems(currentPlayer) + selectedGems.length > MAX_GEMS) { showNotification(`å®çŸ³å·²è¾¾ä¸Šé™ (10ä¸ª)ï¼è¯·å…ˆèŠ±è´¹`, 'error'); setSelectedGems([]); return; }
            saveState();
            const newBank = { ...bank };
            const newPlayer = { ...currentPlayer, gems: { ...currentPlayer.gems } };
            selectedGems.forEach(g => { newBank[g]--; newPlayer.gems[g]++; });
            setBank(newBank); updatePlayer(newPlayer);
            addLog(`${currentPlayer.name} æ‹¿å–: ${selectedGems.map(g => GEM_STYLES[g].label).join(' ')}`);
            setSelectedGems([]); endTurn(newPlayer);
          };

          const handleCardInteraction = (card, action, checkOnly = false) => {
              if (action === 'buy') return handleBuyCard(card, false, checkOnly);
              if (action === 'reserve') return handleReserveCard(card);
          };

          const handleBuyCard = (card, fromReserved = false, checkOnly = false) => {
            if (!canAfford(currentPlayer, card)) {
                if (!checkOnly) showNotification("èµ„æºä¸è¶³ï¼", 'error');
                return false;
            }
            if (checkOnly) return true;
            
            saveState();
            const payment = getAffordCost(currentPlayer, card);
            const newBank = { ...bank };
            const newPlayer = { ...currentPlayer, gems: { ...currentPlayer.gems }, bonuses: { ...currentPlayer.bonuses } };
            Object.entries(payment).forEach(([type, amt]) => { newBank[type] += amt; newPlayer.gems[type] -= amt; });
            newPlayer.bonuses[card.bonus]++;
            newPlayer.score += card.points;
            if (fromReserved) {
                newPlayer.reserved = newPlayer.reserved.filter(c => c.id !== card.id);
                setViewingReservedPlayer(null);
            } else {
                replaceCardOnBoard(card);
            }
            setBank(newBank); addLog(`${newPlayer.name} è´­ä¹° (+${card.points})`); checkNoblesVisit(newPlayer);
            return true;
          };

          const handleReserveCard = (card) => {
            if (currentPlayer.reserved.length >= MAX_RESERVED) { showNotification("é¢„ç•™ä½å·²æ»¡ (æœ€å¤š3å¼ )", 'error'); return; }
            saveState();
            const newPlayer = { ...currentPlayer, reserved: [...currentPlayer.reserved, card] };
            const newBank = { ...bank };
            if (newBank.gold > 0) {
              if (totalGems(newPlayer) < MAX_GEMS) { newBank.gold--; newPlayer.gems.gold++; addLog(`${newPlayer.name} é¢„ç•™+é»„é‡‘`); }
              else addLog(`${newPlayer.name} é¢„ç•™ (æ»¡)`);
            } else addLog(`${newPlayer.name} é¢„ç•™ (æ— é»„é‡‘)`);
            
            updatePlayer(newPlayer);
            replaceCardOnBoard(card); setBank(newBank); setIsReserving(false); endTurn(newPlayer);
          };

          const replaceCardOnBoard = (card) => {
            const lvl = card.level;
            const newBoard = { ...board };
            const row = newBoard[lvl].filter(c => c.id !== card.id);
            if (deck[lvl].length > 0) row.push(deck[lvl].pop());
            newBoard[lvl] = row; setBoard(newBoard);
          };

          const checkNoblesVisit = (player) => {
            let visitedSomething = false;
            const newNobles = [...nobles];
            const playerNobles = [...player.visitedNobles];
            const newPlayer = { ...player };
            for (let i = newNobles.length - 1; i >= 0; i--) {
              const noble = newNobles[i];
              let eligible = true;
              for (const [type, req] of Object.entries(noble.req)) { if (player.bonuses[type] < req) { eligible = false; break; } }
              if (eligible) {
                const msg = `ğŸ‰ è´µæ—æ¥è®¿ï¼${player.name} è·å¾—è´µæ—å¡ï¼`;
                addLog(msg);
                showNotification(msg, 'success'); 
                newPlayer.score += noble.points;
                playerNobles.push(noble);
                newNobles.splice(i, 1);
                visitedSomething = true;
                break; 
              }
            }
            if (visitedSomething) { newPlayer.visitedNobles = playerNobles; setNobles(newNobles); }
            updatePlayer(newPlayer); endTurn(newPlayer);
          };

          const updatePlayer = (newPlayer) => { const newPlayers = [...players]; newPlayers[currentPlayerIndex] = newPlayer; setPlayers(newPlayers); };
          const endTurn = (finalPlayerState) => {
            if (finalPlayerState.score >= POINTS_TO_WIN) { 
                showNotification(`ğŸ† ${finalPlayerState.name} è·èƒœï¼`, 'success'); 
                setWinner(finalPlayerState); 
                setTimeout(() => setGameState('end'), 2000); 
                return; 
            }
            setTurn(turn + 1); setSelectedGems([]);
          };

          if (gameState === 'setup') {
            return (
              <div className="h-screen w-screen bg-slate-900 flex flex-col items-center justify-center text-white font-serif relative overflow-hidden">
                <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-amber-500/20 blur-[100px] rounded-full pointer-events-none"></div>
                <div className="z-10 text-center space-y-6 animate-fade-in-up">
                  <Crown size={60} className="mx-auto text-amber-500 animate-bounce" />
                  <h1 className="text-6xl font-black bg-gradient-to-b from-amber-300 to-amber-600 bg-clip-text text-transparent drop-shadow-sm tracking-widest uppercase">Splendor</h1>
                  <h2 className="text-xl text-slate-400 tracking-widest border-t border-b border-slate-700 py-2 inline-block">ç’€ç’¨å®çŸ³</h2>
                  <div className="h-4"></div>
                  <button onClick={initGame} className="px-12 py-4 bg-gradient-to-r from-amber-600 to-yellow-600 rounded-full text-lg font-bold hover:scale-105 active:scale-95 transition-all border-2 border-amber-400/50 text-white shadow-xl">å¼€å§‹æ¸¸æˆ (2äººå¯¹æˆ˜)</button>
                </div>
              </div>
            );
          }

          if (gameState === 'diceroll') {
              return <DiceRollModal onRollComplete={startGame} />;
          }

          return (
            <div className="h-full w-full bg-[#0f172a] text-slate-200 overflow-hidden font-sans select-none flex flex-col">
              {notification && <Notification msg={notification} type={notifType} />}

              {/* Header */}
              <div className="h-10 lg:h-12 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 lg:px-6 shadow-2xl z-40 shrink-0">
                <div className="flex items-center gap-2 text-amber-500 font-serif font-black text-lg lg:text-xl tracking-wide"><Crown size={20} strokeWidth={2.5} /> SPLENDOR</div>
                
                {/* é¡¶éƒ¨çŠ¶æ€æ  */}
                <div className="flex gap-4 lg:gap-8 bg-slate-800 px-3 lg:px-4 py-1 rounded-full border border-slate-700 shadow-inner text-xs lg:text-sm">
                  <div className={`flex items-center gap-2 ${currentPlayerIndex === 0 ? 'text-amber-400 font-bold' : 'text-slate-500'}`}><div className={`w-1.5 h-1.5 rounded-full ${currentPlayerIndex === 0 ? 'bg-amber-400 animate-pulse' : 'bg-slate-700'}`}></div>ç©å®¶ 1</div>
                  <div className="text-slate-700 font-thin">|</div>
                  <div className={`flex items-center gap-2 ${currentPlayerIndex === 1 ? 'text-amber-400 font-bold' : 'text-slate-500'}`}><div className={`w-1.5 h-1.5 rounded-full ${currentPlayerIndex === 1 ? 'bg-amber-400 animate-pulse' : 'bg-slate-700'}`}></div>ç©å®¶ 2</div>
                </div>

                <div className="flex gap-2">
                    <button onClick={undo} disabled={history.length === 0} className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors border border-slate-700 text-xs lg:text-sm font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                        <Undo2 size={14}/><span>æ’¤é”€</span>
                    </button>
                    <button onClick={() => setGameState('setup')} className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors border border-slate-700 text-xs lg:text-sm font-bold">
                      <RotateCcw size={14}/><span>é‡æ–°é–‹å§‹</span>
                    </button>
                </div>
              </div>

              {/* Middle Section */}
              <div className="flex-1 flex overflow-hidden relative"> 
                {/* Left Sidebar */}
                <div className="w-32 lg:w-40 xl:w-48 bg-[#0f172a] border-r border-slate-800 p-2 lg:p-3 flex flex-col gap-2 z-10 shadow-xl shrink-0 h-full">
                  <div className="flex flex-col gap-1 items-center shrink-0 mb-2">
                     <div className="text-amber-500 font-serif font-bold text-[10px] lg:text-xs mb-1 uppercase tracking-widest flex items-center gap-1 w-full border-b border-amber-900/30 pb-1"><Crown size={12} /> è´µæ—</div>
                     <div className="flex flex-col gap-2 justify-center w-full items-center">
                        {nobles.length > 0 ? nobles.map(n => <NobleTile key={n.id} noble={n} />) : (<div className="text-slate-600 italic text-xs py-2">è´µæ—ç¦»åœº</div>)}
                     </div>
                  </div>
                  <div className="h-px bg-slate-800 w-full shrink-0 my-1"></div>
                  <div className="flex items-center gap-2 text-[10px] lg:text-xs font-bold text-slate-500 uppercase tracking-widest shrink-0"><ScrollText size={12} /> æ¸¸æˆæ—¥å¿—</div>
                  <div className="flex-1 rounded-lg text-[10px] lg:text-xs overflow-y-auto font-mono space-y-2 custom-scrollbar pr-1 min-h-0 flex flex-col">
                    <div className="mt-auto">
                        {logs.map((l, i) => (<div key={i} className="text-slate-400 leading-tight border-l-2 border-slate-700 pl-2 py-0.5">{l}</div>))}
                        <div ref={logsEndRef} />
                    </div>
                  </div>
                </div>

                {/* Center Game Board */}
                <div className="flex-1 flex flex-col items-center justify-between relative z-0 overflow-hidden bg-[#0f172a] h-full">
                    {/* Reserve Overlay Hint */}
                    {isReserving && (
                        <div className="absolute top-2 left-1/2 -translate-x-1/2 bg-yellow-500/90 text-black px-4 py-1 rounded-full font-bold text-sm shadow-lg z-30 animate-bounce pointer-events-none">
                            è¯·é€‰æ‹©ä¸€å¼ å¡ç‰‡è¿›è¡Œé¢„ç•™
                        </div>
                    )}
                    <div className="w-full h-full flex flex-col items-center justify-evenly py-2 lg:py-4">
                        {[3, 2, 1].map(level => (
                          <div key={level} className="flex gap-1.5 lg:gap-3 xl:gap-6 justify-center items-center w-full px-1 lg:px-2">
                            <div className={`prevent-squish ${CARD_SIZE_CLASSES} rounded-lg lg:rounded-xl border-2 flex flex-col items-center justify-center shadow-xl relative shrink-0 ${LEVEL_CONFIG[level].bg} ${LEVEL_CONFIG[level].borderColor}`}>
                              <div className={`text-3xl lg:text-4xl font-serif font-black ${LEVEL_CONFIG[level].dotColor}`}>{Array(level).fill('â—').join('')}</div>
                              <div className="mt-1 text-[9px] lg:text-[10px] font-bold text-slate-500 uppercase tracking-widest">Deck</div>
                              <div className="text-xs lg:text-sm font-bold text-white">{deck[level].length}</div>
                            </div>
                            {board[level].map(card => (
                                <Card 
                                    key={card.id} 
                                    card={card} 
                                    canBuy={gameState === 'playing' && canAfford(currentPlayer, card)} 
                                    isReserving={isReserving}
                                    onBuy={handleCardInteraction} 
                                />
                            ))}
                            {Array(4 - board[level].length).fill(0).map((_, i) => (
                                <div key={i} className={`prevent-squish ${CARD_SIZE_CLASSES} rounded-lg lg:rounded-xl border-2 border-dashed border-slate-700 bg-slate-800/30 shrink-0`}></div>
                            ))}
                          </div>
                        ))}
                    </div>
                </div>

                {/* Right Sidebar */}
                <div className="w-32 lg:w-36 xl:w-40 bg-[#0f172a] border-l border-slate-800 p-2 lg:p-3 flex flex-col gap-1 z-10 shadow-xl shrink-0 h-full overflow-y-auto custom-scrollbar">
                  <div className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1 text-center shrink-0">å®çŸ³é“¶è¡Œ</div>
                  <div className="flex-1 flex flex-col gap-1 lg:gap-2 justify-between min-h-0">
                    <button 
                        onClick={() => handleGemClick('gold')} 
                        disabled={bank.gold === 0 && !isReserving}
                        className={`prevent-squish relative flex-1 rounded-lg lg:rounded-xl flex flex-col items-center justify-center border transition-all min-h-[40px] ${isReserving ? 'bg-yellow-500 border-yellow-300 ring-2 ring-yellow-400' : 'bg-yellow-900/10 border-yellow-900/30 opacity-80 hover:opacity-100 active:scale-95'}`}
                    >
                        <GemToken type="gold" size="md" showCount={false} />
                        {/* ä¿®æ”¹ï¼šæ–‡å­—ä¿æŒâ€œé»„é‡‘â€ï¼Œé€šè¿‡èƒŒæ™¯è‰²åŒºåˆ†çŠ¶æ€ */}
                        <span className={`text-[10px] lg:text-xs font-bold mt-0.5 ${isReserving ? 'text-black' : 'text-yellow-700'}`}>é»„é‡‘</span>
                        <span className={`absolute top-1 right-2 text-xs font-black ${isReserving ? 'text-black' : 'text-yellow-800'}`}>{bank.gold}</span>
                    </button>
                    {GEM_TYPES.map(type => (
                      <button key={type} onClick={() => handleGemClick(type)} disabled={bank[type] === 0 || gameState !== 'playing'} className={`prevent-squish relative flex-1 rounded-lg lg:rounded-xl flex flex-col items-center justify-center transition-all group min-h-[40px] bg-slate-800/40 border border-slate-700 active:bg-slate-700 ${selectedGems.includes(type) ? 'ring-2 ring-emerald-500 bg-slate-800' : ''} ${bank[type] === 0 ? 'opacity-30 grayscale cursor-not-allowed' : ''}`}>
                        <GemToken type={type} size="md" showCount={false} />
                        <span className="text-[10px] font-bold text-slate-400 mt-0.5 group-hover:text-white">{GEM_STYLES[type].label}</span>
                        <span className="absolute top-1 right-2 text-xs font-black text-slate-600 group-hover:text-slate-300">{bank[type]}</span>
                        {selectedGems.filter(g => g === type).length > 0 && (<div className="absolute top-1 left-1 bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold shadow-lg border border-slate-900 z-10">{selectedGems.filter(g => g === type).length}</div>)}
                      </button>
                    ))}
                  </div>
                  <div className="mt-1 space-y-1 shrink-0">
                     {selectedGems.length > 0 ? (
                      <><button onClick={confirmTakeGems} className="w-full py-2 bg-gradient-to-r from-emerald-600 to-green-500 text-white font-bold rounded-lg shadow-lg active:scale-95 transition-all text-xs">ç¡®è®¤</button>
                        <button onClick={() => setSelectedGems([])} className="w-full py-1 text-slate-500 text-[10px] font-bold uppercase tracking-wider hover:text-white">å–æ¶ˆ</button></>
                     ) : (<div className="p-2 rounded bg-slate-900/50 border border-slate-800 text-center"><p className="text-[10px] text-slate-500">è½®åˆ° <span className="text-amber-500 font-bold">{currentPlayer.name}</span></p></div>)}
                  </div>
                </div>
              </div>

              {/* Footer */}
              <div className="h-28 lg:h-36 xl:h-44 bg-[#0f172a] border-t border-slate-800 grid grid-cols-2 divide-x divide-slate-800 z-30 shrink-0 shadow-2xl">
                {players.map((p, idx) => {
                  const isActive = currentPlayerIndex === idx;
                  return (
                  <div key={p.id} className={`flex transition-colors relative ${isActive ? 'bg-slate-900/50 -mt-[2px] z-10 box-content shadow-[inset_0_0_30px_rgba(245,158,11,0.1)]' : 'bg-[#0f172a]'}`}>
                    {/* Active turn indicator - Thinner gradient bar */}
                    {isActive && (
                        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-500 to-transparent shadow-[0_0_20px_rgba(245,158,11,0.8)] z-20"></div>
                    )}
                    {isActive && <div className="absolute top-0 right-0 bg-amber-500 text-amber-950 text-[10px] font-bold px-2 py-0.5 rounded-bl-lg shadow-md animate-pulse">å½“å‰å›åˆ</div>}
                    
                    <div className="w-20 lg:w-24 xl:w-28 flex flex-col items-center justify-center p-1 border-r border-slate-800/50 gap-1 lg:gap-2">
                       <div className={`w-8 h-8 lg:w-10 lg:h-10 rounded-full flex items-center justify-center border-2 shadow-lg transition-transform ${isActive ? 'bg-amber-600 border-amber-400 text-white scale-110' : 'bg-slate-800 border-slate-700 text-slate-500'}`}><User size={18} /></div>
                       <div className="text-center"><div className={`font-bold text-xs lg:text-sm leading-none mb-0.5 ${isActive ? 'text-white' : 'text-slate-500'}`}>{p.name}</div></div>
                       <div className="flex flex-col items-center bg-black/20 p-1 rounded-lg w-full"><div className="text-yellow-500 font-black text-lg lg:text-xl">{p.score}</div></div>
                    </div>
                    <div className="w-10 lg:w-14 border-r border-slate-800/50 flex flex-col p-1 bg-black/10">
                       <div className="text-[8px] text-slate-600 font-bold uppercase mb-1 text-center">è´µæ— ({p.visitedNobles.length})</div>
                       <div className="flex-1 flex flex-col gap-1 items-center justify-start overflow-y-auto custom-scrollbar">
                          {p.visitedNobles.length > 0 ? p.visitedNobles.map((n, i) => (<MiniNoble key={i} noble={n} />)) : (<div className="w-8 h-8 rounded border border-dashed border-slate-700 flex items-center justify-center opacity-30"><Crown size={14} /></div>)}
                       </div>
                    </div>
                    <div className="flex-1 flex flex-col border-r border-slate-800/50">
                       <div className="flex-1 flex items-center px-1 lg:px-2 border-b border-slate-800/50 relative bg-black/10">
                          <div className="flex-1 flex justify-around items-center">
                              <div className="flex flex-col items-center"><GemToken type="gold" size="sm" count={p.gems.gold} className="scale-90" /></div>
                              <div className="w-px h-6 bg-slate-700/30"></div>
                              {GEM_TYPES.map(t => (<div key={t} className="flex flex-col items-center"><GemToken type={t} size="sm" count={p.gems[t]} className={`${p.gems[t] === 0 ? 'opacity-20 grayscale' : ''} scale-90`} /></div>))}
                          </div>
                       </div>
                       <div className="flex-1 flex items-center px-1 lg:px-2 relative">
                          <div className="flex-1 flex justify-around items-center">
                              {GEM_TYPES.map(t => (<div key={t} className={`${p.bonuses[t] === 0 ? 'opacity-10 grayscale' : ''}`}><BonusCardStack type={t} count={p.bonuses[t]} /></div>))}
                          </div>
                       </div>
                    </div>
                    <div className="w-20 lg:w-28 flex flex-col p-1 lg:p-2 bg-black/20 relative group cursor-pointer hover:bg-white/5 transition-colors" onClick={() => setViewingReservedPlayer(p)}>
                       <div className="flex items-center gap-1 mb-1 opacity-50 text-[8px] font-bold uppercase tracking-wider text-slate-400 text-center justify-center"><Grip size={10} /> é¢„ç•™ ({p.reserved.length})</div>
                       <div className="flex-1 grid grid-cols-2 grid-rows-2 gap-1 items-center justify-center">
                          {p.reserved.map((c) => {
                            const style = GEM_STYLES[c.bonus];
                            return (
                                <div key={c.id} className={`w-full h-full rounded border-2 flex items-center justify-center relative shadow-md transition-transform ${style.cardBorder} ${style.cardBg}`}>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center opacity-80">
                                        <div className="scale-50"><GemIconSVG type={c.bonus} className={style.iconFill} /></div>
                                    </div>
                                    <div className="absolute bottom-0.5 right-1 font-black text-white text-[8px] drop-shadow-md text-stroke-black">{c.points || ''}</div>
                                    {canAfford(p, c) && <div className="absolute top-0 left-0 w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse shadow-lg"></div>}
                                </div>
                            );
                          })}
                          {Array(4 - p.reserved.length).fill(0).map((_, i) => (<div key={i} className={`w-full h-full rounded border border-dashed border-slate-800/50 bg-black/10 flex items-center justify-center ${i + p.reserved.length >= 3 ? 'opacity-20 bg-red-900/10' : ''}`}>{i + p.reserved.length >= 3 ? <Lock size={10} className="text-slate-700" /> : null}</div>))}
                       </div>
                    </div>
                  </div>
                )})}
              </div>

              {viewingReservedPlayer && (
                  <ReservedCardsModal 
                      player={viewingReservedPlayer} 
                      currentPlayer={currentPlayer} 
                      onClose={() => setViewingReservedPlayer(null)}
                      onBuy={handleBuyCard}
                  />
              )}

              {gameState === 'end' && (
                <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                  <div className="bg-slate-900 border-2 border-amber-500 rounded-2xl p-6 xl:p-10 max-w-lg w-full text-center shadow-[0_0_100px_rgba(245,158,11,0.2)]">
                    <Trophy size={60} className="text-amber-500 mx-auto mb-4" />
                    <h2 className="text-3xl xl:text-5xl font-black text-white mb-2">{winner?.name} è·èƒœï¼</h2>
                    <div className="text-xl xl:text-2xl text-amber-400 mb-6 font-bold">æ€»å¾—åˆ†: {winner?.score}</div>
                    <button onClick={initGame} className="w-full py-3 bg-gradient-to-r from-amber-600 to-yellow-600 text-white font-bold rounded-xl text-lg active:scale-95 transition-transform">å†æ¥ä¸€å±€</button>
                  </div>
                </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SplendorGame />);
    </script>
</body>
</html>
