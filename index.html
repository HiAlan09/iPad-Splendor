<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Splendor">
    <title>璀璨宝石 (离线版)</title>
    
    <style>
        /* --- 核心基础样式 (替代 Tailwind) --- */
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --color-emerald: #10b981;
            --color-sapphire: #3b82f6;
            --color-ruby: #ef4444;
            --color-diamond: #f8fafc;
            --color-onyx: #334155;
            --color-gold: #eab308;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            overflow: hidden;
            display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none;
            touch-action: none;
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* 布局工具类 */
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-start { justify-content: flex-start; }
        .justify-around { justify-content: space-around; }
        .flex-1 { flex: 1; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .hidden { display: none !important; }
        .gap-1 { gap: 4px; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .p-1 { padding: 4px; }
        .p-2 { padding: 8px; }
        .p-3 { padding: 12px; }
        
        /* 滚动条隐藏 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- 游戏特定样式 --- */
        
        /* 顶部导航 */
        .header {
            height: 48px;
            background-color: #020617;
            border-bottom: 1px solid #334155;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; flex-shrink: 0; z-index: 50;
        }
        .btn-reset {
            background: #1e293b; color: #cbd5e1; border: 1px solid #334155;
            padding: 4px 12px; border-radius: 999px; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; gap: 4px; cursor: pointer;
        }
        .btn-reset:active { background: #334155; color: white; }

        /* 主区域布局 */
        .main-area { flex: 1; display: flex; overflow: hidden; position: relative; }
        .bg-pattern {
            position: absolute; inset: 0; opacity: 0.15; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.4' fill-rule='evenodd'%3E%3Ccircle cx='3' cy='3' r='3'/%3E%3Ccircle cx='13' cy='13' r='3'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* 侧边栏 (日志 & 银行) */
        .sidebar {
            width: 160px; background: #0f172a; border-right: 1px solid #334155;
            display: flex; flex-direction: column; z-index: 10;
        }
        .sidebar-right { border-right: none; border-left: 1px solid #334155; width: 140px; }
        .section-title { font-size: 10px; font-weight: bold; color: #64748b; text-transform: uppercase; text-align: center; margin-bottom: 4px; letter-spacing: 1px; }

        /* 中间牌桌 */
        .board-container { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 10px; overflow: hidden; }
        .board-scaler { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; transform-origin: top center; transition: transform 0.3s; }
        
        /* 贵族区 */
        .noble-area {
            background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px; padding: 8px; margin-bottom: 8px;
            display: flex; flex-direction: column; align-items: center; width: 95%; flex-shrink: 0;
        }
        
        /* 贵族卡片 */
        .noble-tile {
            width: 90px; height: 120px; flex-shrink: 0;
            background: linear-gradient(135deg, #fef3c7 0%, #fcd34d 100%);
            border: 3px solid #b45309; border-radius: 8px;
            position: relative; display: flex; flex-direction: column; justify-content: space-between; padding: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .noble-points { font-size: 28px; font-weight: 900; color: #451a03; line-height: 1; }
        .noble-req-row { display: flex; align-items: center; background: rgba(255,255,255,0.7); border-radius: 4px; padding: 2px 4px; margin-top: 2px; border: 1px solid #fde68a; }
        .noble-req-val { font-size: 12px; font-weight: bold; color: #451a03; margin-left: 4px; }

        /* 卡牌行 */
        .card-row { display: flex; gap: 12px; margin-bottom: 8px; justify-content: center; height: 160px; width: 100%; flex-shrink: 0; }
        
        /* 牌堆 */
        .deck-stack {
            width: 110px; height: 100%; border-radius: 10px;
            background: #1e293b; border: 2px solid;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.3);
        }
        
        /* 发展卡 */
        .card {
            width: 110px; height: 100%; border-radius: 10px;
            position: relative; overflow: hidden; cursor: pointer;
            border: 2px solid; transition: transform 0.1s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
            background-color: #334155; /* Default */
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card:active { transform: scale(0.95); }
        .card.can-buy { box-shadow: 0 0 0 3px #4ade80, 0 10px 15px rgba(0,0,0,0.5); transform: translateY(-4px); z-index: 10; border-color: #4ade80; }
        
        /* 卡牌纹理 */
        .pat-dots { background-image: radial-gradient(rgba(255,255,255,0.15) 1.5px, transparent 1.5px); background-size: 15px 15px; }
        .pat-grid { background-image: linear-gradient(rgba(255,255,255,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.08) 1px, transparent 1px); background-size: 20px 20px; }
        .pat-lines { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 10px, transparent 10px, transparent 20px); }
        .pat-check { background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%, rgba(255,255,255,0.08)), repeating-linear-gradient(45deg, rgba(255,255,255,0.08) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.08) 75%, rgba(255,255,255,0.08)); background-position: 0 0, 10px 10px; background-size: 20px 20px; }
        .pat-radial { background-image: radial-gradient(circle at center, rgba(0,0,0,0.05) 0%, transparent 70%); }

        /* 卡牌内容 */
        .card-top { padding: 6px; display: flex; justify-content: space-between; align-items: flex-start; z-index: 2; position: relative; }
        .card-points { font-family: "Times New Roman", serif; font-size: 32px; font-weight: 900; line-height: 0.8; color: white; -webkit-text-stroke: 1.5px black; text-shadow: 0 2px 2px rgba(0,0,0,0.5); }
        .card-gem-icon { width: 32px; height: 32px; border-radius: 50%; background: white; border: 2px solid white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .card-center-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.15; width: 80px; height: 80px; pointer-events: none; }
        
        .card-cost-bar { 
            padding: 4px; display: flex; gap: 4px; justify-content: center; align-items: flex-end; 
            border-top: 1px solid rgba(255,255,255,0.2);
            /* 关键：颜色背景在JS中动态设置 */
        }
        .cost-bubble {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: white; text-shadow: 0 1px 2px black;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .cost-bubble.diamond-cost { color: #1e293b; text-shadow: none; }

        /* 预留按钮 */
        .btn-reserve {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: #eab308; color: #422006; font-size: 10px; font-weight: bold;
            padding: 4px 10px; border-radius: 99px; border: 1px solid #fde047;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4); z-index: 20; opacity: 0.9;
        }

        /* 银行按钮 */
        .bank-btn {
            width: 100%; height: 60px; margin-bottom: 6px; border-radius: 10px;
            background: rgba(30, 41, 59, 0.5); border: 1px solid #334155;
            display: flex; align-items: center; justify-content: center; position: relative;
            transition: all 0.1s;
        }
        .bank-btn:active { transform: scale(0.95); background: rgba(30, 41, 59, 0.8); }
        .bank-btn.selected { border-color: #10b981; background: rgba(16, 185, 129, 0.2); box-shadow: 0 0 0 1px #10b981; }
        .bank-btn:disabled { opacity: 0.3; filter: grayscale(1); }
        .bank-count { position: absolute; top: 4px; right: 8px; font-size: 12px; font-weight: bold; color: #94a3b8; }
        .bank-label { font-size: 10px; color: #64748b; font-weight: bold; position: absolute; bottom: 4px; }
        .token-icon { width: 32px; height: 32px; }

        /* 底部玩家 */
        .footer { height: 160px; background: #020617; border-top: 1px solid #1e293b; display: flex; flex-shrink: 0; z-index: 50; }
        .player-panel { flex: 1; border-right: 1px solid #1e293b; display: flex; position: relative; }
        .player-panel.active { background: #0f172a; }
        .active-bar { position: absolute; top: 0; left: 0; width: 100%; height: 3px; background: linear-gradient(90deg, transparent, #f59e0b, transparent); box-shadow: 0 0 10px #f59e0b; }
        
        /* 玩家内部布局 */
        .p-info { width: 90px; padding: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-right: 1px solid #1e293b; }
        .p-avatar { width: 40px; height: 40px; border-radius: 50%; background: #334155; display: flex; align-items: center; justify-content: center; border: 2px solid #475569; margin-bottom: 4px; }
        .active .p-avatar { border-color: #f59e0b; background: #78350f; color: white; }
        .p-score { font-size: 20px; font-weight: 900; color: #f59e0b; }
        
        .p-nobles { width: 40px; background: rgba(0,0,0,0.2); border-right: 1px solid #1e293b; display: flex; flex-direction: column; align-items: center; padding-top: 4px; overflow-y: auto; }
        .mini-noble { width: 30px; height: 30px; background: #fcd34d; border: 1px solid #b45309; border-radius: 4px; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #451a03; flex-shrink: 0; }

        .p-resources { flex: 1; display: flex; flex-direction: column; }
        .res-row { flex: 1; display: flex; align-items: center; justify-content: space-around; border-bottom: 1px solid #1e293b; }
        .res-item { display: flex; flex-direction: column; align-items: center; width: 20px; }
        .mini-token { width: 20px; height: 20px; }
        .mini-card { width: 24px; height: 32px; border-radius: 3px; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; text-shadow: 0 1px 2px black; }

        .p-reserved { width: 80px; background: rgba(0,0,0,0.2); display: flex; flex-direction: column; padding: 4px; align-items: center; }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%; height: 100%; }
        .res-slot { border: 1px dashed #475569; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .res-card { width: 100%; height: 100%; border-radius: 4px; border: 1px solid #94a3b8; background: #334155; position: relative; display: flex; align-items: center; justify-content: center; }
        .res-card.buyable { border-color: #4ade80; box-shadow: 0 0 5px #4ade80; cursor: pointer; }

        /* SVG 图标定义 */
        .icon { width: 100%; height: 100%; }
        .fill-white { fill: white; }
        .fill-black { fill: #1e293b; }
        .stroke-white { stroke: white; stroke-width: 1.5; }
        .stroke-black { stroke: #1e293b; stroke-width: 1.5; }
        .fill-emerald { fill: #10b981; }
        .fill-sapphire { fill: #3b82f6; }
        .fill-ruby { fill: #ef4444; }
        .fill-onyx { fill: #334155; } /* 黑曜石图标 */
        
        /* 胜利弹窗 */
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: #1e293b; border: 2px solid #f59e0b; padding: 30px; border-radius: 16px; text-align: center; width: 300px; }
        .modal h2 { font-size: 32px; color: white; margin: 10px 0; }
        .modal p { color: #f59e0b; font-size: 20px; font-weight: bold; }
        .modal button { margin-top: 20px; background: #d97706; color: white; border: none; padding: 10px 24px; font-size: 18px; border-radius: 8px; width: 100%; }
    </style>
</head>
<body>
    
    <!-- 游戏 UI 结构 -->
    <div id="game-root">
        <!-- 头部 -->
        <div class="header">
            <div style="color: #f59e0b; font-weight: 900; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/></svg>
                SPLENDOR
            </div>
            <div id="turn-indicator" style="font-size: 12px; color: #94a3b8;">
                <span id="turn-p1" style="color: #f59e0b;">● 玩家 1</span> | <span id="turn-p2">玩家 2</span>
            </div>
            <div class="btn-reset" onclick="initGame()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                重新开始
            </div>
        </div>

        <div class="main-area">
            <div class="bg-pattern"></div>
            
            <!-- 左侧日志 -->
            <div class="sidebar" id="log-container">
                <div class="p-2 border-b border-slate-700">
                    <div class="section-title">游戏日志</div>
                </div>
                <div id="logs" class="p-2 no-scrollbar" style="flex:1; overflow-y: auto; font-size: 10px; color: #94a3b8; line-height: 1.4;"></div>
            </div>

            <!-- 中间牌桌 -->
            <div class="board-container">
                <div class="board-scaler" id="board-scaler">
                    <!-- 贵族区 -->
                    <div class="noble-area" id="nobles-area"></div>
                    
                    <!-- 卡牌区 (Level 3, 2, 1) -->
                    <div id="board-rows" style="width: 95%; flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 8px;"></div>
                </div>
            </div>

            <!-- 右侧银行 -->
            <div class="sidebar sidebar-right no-scrollbar" style="overflow-y: auto;">
                <div class="p-2"><div class="section-title">宝石银行</div></div>
                <div id="bank-area" class="p-2 pt-0"></div>
                <div class="p-2">
                    <button id="btn-take" class="btn-reset" style="width:100%; justify-content:center; padding: 10px; background: #059669; color: white; border:none; display:none;" onclick="confirmTakeGems()">确认拿取</button>
                    <button id="btn-cancel" class="btn-reset" style="width:100%; justify-content:center; margin-top:5px; border:none; background:transparent; display:none;" onclick="cancelSelection()">取消</button>
                </div>
            </div>
        </div>

        <!-- 底部玩家 -->
        <div class="footer" id="players-area"></div>
    </div>

    <!-- 胜利弹窗 -->
    <div id="modal-overlay">
        <div class="modal">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" style="margin:0 auto;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
            <h2 id="winner-name">玩家 1 获胜!</h2>
            <p id="winner-score">总分: 15</p>
            <button onclick="initGame()">再来一局</button>
        </div>
    </div>

    <!-- 游戏逻辑 (纯原生JS) -->
    <script>
        // --- 常量配置 ---
        const GEM_TYPES = ['emerald', 'sapphire', 'ruby', 'diamond', 'onyx'];
        const POINTS_TO_WIN = 15;
        const MAX_GEMS = 10;
        
        // 样式定义
        const STYLES = {
            emerald: { bg: '#064e3b', light: '#10b981', border: '#047857', costBg: '#059669', iconColor: '#10b981', label: '绿', pat: 'pat-dots' },
            sapphire: { bg: '#1e3a8a', light: '#3b82f6', border: '#1d4ed8', costBg: '#2563eb', iconColor: '#3b82f6', label: '蓝', pat: 'pat-grid' },
            ruby:     { bg: '#7f1d1d', light: '#ef4444', border: '#b91c1c', costBg: '#dc2626', iconColor: '#ef4444', label: '红', pat: 'pat-lines' },
            diamond:  { bg: '#cbd5e1', light: '#f8fafc', border: '#94a3b8', costBg: '#64748b', iconColor: '#ffffff', label: '白', pat: 'pat-radial', isLight: true },
            onyx:     { bg: '#0f172a', light: '#334155', border: '#1e293b', costBg: '#1e293b', iconColor: '#1e293b', label: '黑', pat: 'pat-check' },
            gold:     { bg: '#78350f', light: '#eab308', border: '#a16207', label: '金' }
        };

        const LVL_CONFIG = {
            1: { color: '#10b981', border: '#064e3b' },
            2: { color: '#eab308', border: '#78350f' },
            3: { color: '#3b82f6', border: '#1e3a8a' }
        };

        // --- 游戏状态 ---
        let state = {
            deck: {},
            board: {},
            nobles: [],
            bank: {},
            players: [],
            turn: 0,
            selectedGems: [],
            logs: [],
            winner: null
        };

        // --- 图标 SVG 字符串 ---
        const ICONS = {
            diamond: `<path d="M2.7 10.3a2.41 2.41 0 0 0 0 3.41l7.59 7.59a2.41 2.41 0 0 0 3.41 0l7.59-7.59a2.41 2.41 0 0 0 0-3.41l-7.59-7.59a2.41 2.41 0 0 0-3.41 0l-7.59 7.59Z"/>`,
            emerald: `<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>`,
            ruby: `<rect width="18" height="18" x="3" y="3" rx="2" transform="rotate(45 12 12)"/>`,
            sapphire: `<path d="M13.73 4a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3l-8-14z" transform="rotate(180 12 12)"/>`,
            onyx: `<circle cx="12" cy="12" r="10" />`,
            gold: `<path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/>`,
            crown: `<path d="m2 4 3 12h14l3-12-6 7-4-3-4 3-6-7zm5 16h10"/>`,
            lock: `<rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>`
        };

        function getSvg(type, className="", style="") {
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}" style="${style}">${ICONS[type] || ''}</svg>`;
        }

        // --- 初始化 ---
        function initGame() {
            // 生成卡牌
            let deck = { 1: [], 2: [], 3: [] };
            let id = 0;
            // Level 1
            for(let i=0; i<40; i++) {
                let bonus = GEM_TYPES[i%5];
                let cost = {};
                // Simple cost gen
                let c1 = GEM_TYPES[(i+1)%5], c2 = GEM_TYPES[(i+2)%5];
                if(i%3===0) { cost[c1]=1; cost[c2]=1; cost[GEM_TYPES[(i+3)%5]]=1; cost[bonus]=1; }
                else if(i%3===1) { cost[c1]=2; cost[c2]=2; } // 2x2
                else { cost[c1]=3; }
                deck[1].push({ id: `1-${id++}`, level:1, points: i%8===0?1:0, bonus, cost });
            }
            // Level 2
            for(let i=0; i<30; i++) {
                let bonus = GEM_TYPES[i%5];
                let cost = {};
                let c1 = GEM_TYPES[(i+2)%5], c2 = GEM_TYPES[(i+3)%5];
                if(i%3===0) { cost[c1]=3; cost[c2]=2; cost[bonus]=2; }
                else if(i%3===1) { cost[c1]=5; }
                else { cost[c1]=4; cost[c2]=2; } // 6
                deck[2].push({ id: `2-${id++}`, level:2, points: (i%3)+1, bonus, cost });
            }
            // Level 3
            for(let i=0; i<20; i++) {
                let bonus = GEM_TYPES[i%5];
                let cost = {};
                let c1 = GEM_TYPES[(i+1)%5], c2 = GEM_TYPES[(i+3)%5];
                if(i%2===0) { cost[c1]=3; cost[c2]=3; cost[bonus]=3; cost[GEM_TYPES[(i+4)%5]]=3; }
                else { cost[c1]=7; }
                deck[3].push({ id: `3-${id++}`, level:3, points: (i%3)+3, bonus, cost });
            }
            // Shuffle
            [1,2,3].forEach(l => {
                for(let i = deck[l].length-1; i>0; i--){
                    const j = Math.floor(Math.random()*(i+1));
                    [deck[l][i], deck[l][j]] = [deck[l][j], deck[l][i]];
                }
            });

            // 生成贵族
            let allNobles = [];
            for(let i=0; i<5; i++) {
                // 2x4
                let req = {}; req[GEM_TYPES[i]]=4; req[GEM_TYPES[(i+1)%5]]=4;
                allNobles.push({id:`n4-${i}`, points:3, req});
                // 3x3
                let req3 = {}; req3[GEM_TYPES[i]]=3; req3[GEM_TYPES[(i+1)%5]]=3; req3[GEM_TYPES[(i+2)%5]]=3;
                allNobles.push({id:`n3-${i}`, points:3, req:req3});
            }
            // Shuffle nobles
            for(let i = allNobles.length-1; i>0; i--){
                const j = Math.floor(Math.random()*(i+1));
                [allNobles[i], allNobles[j]] = [allNobles[j], allNobles[i]];
            }

            state = {
                deck,
                board: { 1: deck[1].splice(0,4), 2: deck[2].splice(0,4), 3: deck[3].splice(0,4) },
                nobles: allNobles.slice(0,3),
                bank: { emerald:4, sapphire:4, ruby:4, diamond:4, onyx:4, gold:5 },
                players: [
                    { id:0, name:"玩家 1", gems:{emerald:0,sapphire:0,ruby:0,diamond:0,onyx:0,gold:0}, bonuses:{emerald:0,sapphire:0,ruby:0,diamond:0,onyx:0}, score:0, reserved:[], visitedNobles:[] },
                    { id:1, name:"玩家 2", gems:{emerald:0,sapphire:0,ruby:0,diamond:0,onyx:0,gold:0}, bonuses:{emerald:0,sapphire:0,ruby:0,diamond:0,onyx:0}, score:0, reserved:[], visitedNobles:[] }
                ],
                turn: 0,
                selectedGems: [],
                logs: ["游戏开始！"],
                winner: null
            };
            
            document.getElementById('modal-overlay').style.display = 'none';
            render();
        }

        // --- 游戏逻辑 ---
        function getCurrentPlayer() { return state.players[state.turn % 2]; }
        
        function addLog(msg) {
            state.logs.unshift(msg);
            renderLogs();
        }

        function canAfford(player, card) {
            let missing = 0;
            for(let type in card.cost) {
                let cost = card.cost[type];
                let discount = player.bonuses[type];
                let needed = Math.max(0, cost - discount);
                if(player.gems[type] < needed) missing += (needed - player.gems[type]);
            }
            return player.gems.gold >= missing;
        }

        function handleGemClick(type) {
            if(type==='gold' || state.bank[type]<=0) return;
            const sel = state.selectedGems;
            
            // Logic: 2 same or 3 diff
            if(sel.length >= 3) return; // Full
            if(sel.length === 2 && sel[0] === sel[1]) return; // Already double

            let countInSel = sel.filter(g=>g===type).length;
            if(countInSel === 1) {
                if(state.bank[type]<4) { alert("剩余不足4个，不能拿取2个"); return; }
                if(sel.length > 1) { alert("已选异色，不能拿同色"); return; }
            }
            if(sel.length === 2 && sel[0]!==sel[1] && sel.includes(type)) { alert("不能重复拿取"); return; }
            
            state.selectedGems.push(type);
            renderBank();
        }

        function cancelSelection() {
            state.selectedGems = [];
            renderBank();
        }

        function confirmTakeGems() {
            if(state.selectedGems.length===0) return;
            let p = getCurrentPlayer();
            let total = Object.values(p.gems).reduce((a,b)=>a+b,0);
            if(total + state.selectedGems.length > 10) { alert("手牌宝石上限为10！"); state.selectedGems=[]; renderBank(); return; }

            state.selectedGems.forEach(g => {
                state.bank[g]--;
                p.gems[g]++;
            });
            addLog(`${p.name} 拿取: ${state.selectedGems.map(t=>STYLES[t].label).join(' ')}`);
            state.selectedGems = [];
            endTurn();
        }

        function handleBuy(cardId, level, fromReserved=false) {
            let p = getCurrentPlayer();
            // Find card
            let card;
            if(fromReserved) {
                card = p.reserved.find(c=>c.id===cardId);
            } else {
                card = state.board[level].find(c=>c.id===cardId);
            }
            
            if(!canAfford(p, card)) return;

            // Pay
            let cost = card.cost;
            for(let type in cost) {
                let discount = p.bonuses[type];
                let realCost = Math.max(0, cost[type] - discount);
                let payGem = Math.min(p.gems[type], realCost);
                p.gems[type] -= payGem;
                state.bank[type] += payGem;
                let payGold = realCost - payGem;
                if(payGold > 0) {
                    p.gems.gold -= payGold;
                    state.bank.gold += payGold;
                }
            }

            // Get card
            p.bonuses[card.bonus]++;
            p.score += card.points;
            
            if(fromReserved) {
                p.reserved = p.reserved.filter(c=>c.id!==cardId);
            } else {
                // Replace on board
                let row = state.board[level];
                let idx = row.findIndex(c=>c.id===cardId);
                if(idx !== -1) {
                    if(state.deck[level].length > 0) row[idx] = state.deck[level].pop();
                    else row.splice(idx, 1);
                }
            }

            addLog(`${p.name} 购买了 ${STYLES[card.bonus].label} 卡牌`);
            checkNobles(p);
        }

        function handleReserve(cardId, level) {
            let p = getCurrentPlayer();
            if(p.reserved.length >= 3) { alert("预留位已满"); return; }
            
            let card = state.board[level].find(c=>c.id===cardId);
            p.reserved.push(card);
            
            // Gold
            if(state.bank.gold > 0) {
                let total = Object.values(p.gems).reduce((a,b)=>a+b,0);
                if(total < 10) {
                    state.bank.gold--;
                    p.gems.gold++;
                }
            }

            // Replace
            let row = state.board[level];
            let idx = row.findIndex(c=>c.id===cardId);
            if(state.deck[level].length > 0) row[idx] = state.deck[level].pop();
            else row.splice(idx, 1);

            addLog(`${p.name} 预留了卡牌`);
            endTurn();
        }

        function checkNobles(p) {
            // Check nobles
            let earned = false;
            for(let i=state.nobles.length-1; i>=0; i--) {
                let n = state.nobles[i];
                let ok = true;
                for(let t in n.req) {
                    if(p.bonuses[t] < n.req[t]) { ok = false; break; }
                }
                if(ok) {
                    p.score += n.points;
                    p.visitedNobles.push(n);
                    state.nobles.splice(i, 1);
                    addLog(`${p.name} 获得了贵族 (${n.points}分)`);
                    earned = true;
                    break; // Limit 1 per turn usually
                }
            }
            endTurn();
        }

        function endTurn() {
            let p = getCurrentPlayer();
            if(p.score >= 15) {
                state.winner = p;
                render();
                document.getElementById('winner-name').textContent = p.name + " 获胜！";
                document.getElementById('winner-score').textContent = "总分: " + p.score;
                document.getElementById('modal-overlay').style.display = 'flex';
                return;
            }
            state.turn++;
            render();
        }

        // --- 渲染逻辑 ---

        function render() {
            renderHeader();
            renderLogs();
            renderBank();
            renderBoard();
            renderPlayers();
            
            // Auto scale board
            const h = window.innerHeight;
            const scaler = document.getElementById('board-scaler');
            if(h < 850) {
                scaler.style.transform = `scale(${Math.min(1, h/900)})`;
            } else {
                scaler.style.transform = 'scale(1)';
            }
        }

        function renderHeader() {
            let p1 = state.players[0], p2 = state.players[1];
            let cur = state.turn % 2;
            document.getElementById('turn-p1').style.color = cur===0 ? '#f59e0b' : '#64748b';
            document.getElementById('turn-p1').style.fontWeight = cur===0 ? 'bold' : 'normal';
            document.getElementById('turn-p2').style.color = cur===1 ? '#f59e0b' : '#64748b';
            document.getElementById('turn-p2').style.fontWeight = cur===1 ? 'bold' : 'normal';
        }

        function renderLogs() {
            document.getElementById('logs').innerHTML = state.logs.map(l => `<div>> ${l}</div>`).join('');
        }

        function renderBank() {
            const container = document.getElementById('bank-area');
            let html = '';
            
            // Gold
            html += `<div class="bank-btn">
                <div class="token-icon">${getSvg('gold', 'icon fill-white stroke-black')}</div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div style="width:40px; height:40px; background:radial-gradient(#fcd34d, #b45309); border-radius:50%; border:2px solid #fff; box-shadow:0 2px 5px rgba(0,0,0,0.5);"></div>
                </div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none text-yellow-900 font-bold text-lg"></div>
                <span class="bank-count">${state.bank.gold}</span>
                <span class="bank-label" style="color:#fcd34d">黄金</span>
            </div>`;

            // Gems
            GEM_TYPES.forEach(t => {
                let count = state.selectedGems.filter(g=>g===t).length;
                let disabled = state.turn%2 !== 0 && false; // simplified
                let style = STYLES[t];
                
                html += `<div class="bank-btn ${count>0?'selected':''}" onclick="handleGemClick('${t}')">
                    <div style="width:40px; height:40px; background:${style.light}; border-radius:50%; border:2px solid ${style.border}; box-shadow:inset 0 0 10px rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;">
                         ${getSvg(t, 'fill-white stroke-none', 'width:60%; height:60%')}
                    </div>
                    <span class="bank-count text-white">${state.bank[t]}</span>
                    <span class="bank-label">${style.label}</span>
                    ${count>0 ? `<div class="absolute top-0 left-0 bg-green-500 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center border border-black">${count}</div>` : ''}
                </div>`;
            });

            container.innerHTML = html;
            
            // Buttons
            const hasSel = state.selectedGems.length > 0;
            document.getElementById('btn-take').style.display = hasSel ? 'flex' : 'none';
            document.getElementById('btn-cancel').style.display = hasSel ? 'flex' : 'none';
            document.getElementById('btn-take').innerHTML = `确认 (${state.selectedGems.length})`;
        }

        function renderBoard() {
            // Nobles
            const nArea = document.getElementById('nobles-area');
            if(state.nobles.length === 0) nArea.innerHTML = '<div style="color:#64748b; font-size:12px;">贵族已全部离场</div>';
            else {
                nArea.innerHTML = state.nobles.map(n => {
                    let reqHtml = '';
                    for(let t in n.req) {
                        let s = STYLES[t];
                        reqHtml += `<div class="noble-req-row">
                            <div style="width:12px; height:12px; border-radius:50%; background:${s.light}; border:1px solid ${s.border};"></div>
                            <span class="noble-req-val">${n.req[t]}</span>
                        </div>`;
                    }
                    return `<div class="noble-tile">
                        <div class="noble-points">${n.points}</div>
                        <div style="display:flex; flex-direction:column; align-items:flex-end;">${reqHtml}</div>
                        <div style="position:absolute; top:2px; right:2px; opacity:0.3; color:#b45309">${getSvg('crown')}</div>
                    </div>`;
                }).join('');
            }

            // Rows
            const rows = document.getElementById('board-rows');
            let html = '';
            [3, 2, 1].forEach(lvl => {
                let color = LVL_CONFIG[lvl].color;
                let border = LVL_CONFIG[lvl].border;
                
                let cardsHtml = state.board[lvl].map(c => {
                    let s = STYLES[c.bonus];
                    let can = canAfford(getCurrentPlayer(), c);
                    
                    // 成本栏
                    let costHtml = '';
                    for(let t in c.cost) {
                        let cs = STYLES[t];
                        costHtml += `<div class="cost-bubble ${t==='diamond'?'diamond-cost':''}" style="background:${cs.light}; border-color:${cs.border}">${c.cost[t]}</div>`;
                    }

                    // 1. 白色钻石卡：bg-slate-200, 费用栏深灰
                    // 2. 黑卡：bg-slate-900, 费用栏深黑
                    // 3. 其他：bg-color-900, 费用栏 high saturation
                    let bgClass = s.bg; 
                    let costBg = s.costBg;
                    if(c.bonus === 'diamond') { bgClass = '#cbd5e1'; costBg = '#64748b'; } // 钻石卡优化：银白底，深灰栏
                    if(c.bonus === 'onyx') { bgClass = '#0f172a'; costBg = '#1e293b'; }

                    // 分数颜色：统一白色+描边
                    let pointColor = 'white'; 
                    let textShadow = '-1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000'; // CSS text stroke hack

                    // 右上角图标：白底 + 彩色填充 + (可选描边)
                    // 钻石：白底 + 白填充 + 黑描边
                    let iconFill = s.light;
                    let iconStroke = 'none';
                    if (c.bonus === 'diamond') { iconFill = 'white'; iconStroke = 'black'; }

                    return `<div class="card ${can ? 'can-buy' : ''}" style="background-color:${bgClass}; border-color:${s.border}" onclick="handleBuy('${c.id}', ${lvl})">
                        <div class="${s.pat}" style="position:absolute; inset:0; opacity:0.15;"></div>
                        
                        <!-- 中心水印：白填充+黑描边，半透明 -->
                        <div class="card-center-icon" style="color:white; fill:white; stroke:black; stroke-width:1;">
                           ${getSvg(c.bonus)}
                        </div>

                        <div class="card-top">
                            <div class="card-points" style="color:${pointColor}; text-shadow:${textShadow}">${c.points>0?c.points:''}</div>
                            <div class="card-gem-icon">
                                ${getSvg(c.bonus, '', `fill:${iconFill}; stroke:${iconStroke}; stroke-width:1.5px; width:22px; height:22px`)}
                            </div>
                        </div>

                        ${!can ? `<div class="btn-reserve" onclick="event.stopPropagation(); handleReserve('${c.id}', ${lvl})">
                            <div style="display:flex; align-items:center; gap:2px;">${getSvg('lock', '', 'width:10px;')} 预留</div>
                        </div>` : ''}

                        <div class="card-cost-bar" style="background-color:${costBg};">
                            ${costHtml}
                        </div>
                    </div>`;
                }).join('');

                // Fillers
                for(let i=0; i< 4 - state.board[lvl].length; i++) {
                    cardsHtml += `<div style="width:110px; height:100%; border:2px dashed #334155; border-radius:10px; background:rgba(0,0,0,0.1)"></div>`;
                }

                html += `<div class="card-row">
                    <div class="deck-stack" style="border-color:${border}">
                        <div style="font-size:32px; font-weight:900; color:${color}">
                            ${lvl===1?'●':(lvl===2?'●●':'●●●')}
                        </div>
                        <div style="font-size:10px; color:#94a3b8; font-weight:bold; margin-top:4px;">剩余</div>
                        <div style="font-size:14px; color:white; font-weight:bold;">${state.deck[lvl].length}</div>
                    </div>
                    ${cardsHtml}
                </div>`;
            });
            rows.innerHTML = html;
        }

        function renderPlayers() {
            const container = document.getElementById('players-area');
            container.innerHTML = state.players.map((p, idx) => {
                let active = idx === state.turn % 2;
                
                // Noble icons
                let noblesHtml = p.visitedNobles.map(n => `<div class="mini-noble">${n.points}</div>`).join('');
                
                // Resources
                let tokensHtml = GEM_TYPES.map(t => `<div class="res-item"><div class="mini-token" style="background:${STYLES[t].light}; border:1px solid ${STYLES[t].border}; border-radius:50%; box-shadow:0 1px 2px black;"></div><span style="font-size:12px; font-weight:bold;">${p.gems[t]}</span></div>`).join('');
                tokensHtml = `<div class="res-item"><div class="mini-token" style="background:#eab308; border-radius:50%; border:1px solid #fff;"></div><span style="font-size:12px; font-weight:bold; color:#fcd34d">${p.gems.gold}</span></div>` + tokensHtml;

                // Cards
                let cardsHtml = GEM_TYPES.map(t => {
                    let count = p.bonuses[t];
                    let style = STYLES[t];
                    let bg = t==='diamond' ? '#94a3b8' : style.costBg; // Cards display bg
                    let iconFill = t==='diamond' ? 'white' : style.light;
                    return `<div class="res-item" style="opacity:${count>0?1:0.3}">
                        <div class="mini-card" style="background:${bg}; border-color:${style.border}">
                           ${getSvg(t, '', `width:14px; fill:${iconFill}; stroke:${t==='diamond'?'black':'none'}`)}
                        </div>
                        <span style="font-size:12px; font-weight:bold; margin-top:2px;">${count}</span>
                    </div>`;
                }).join('');

                // Reserved
                let resHtml = p.reserved.map(c => {
                     let can = canAfford(p, c);
                     let s = STYLES[c.bonus];
                     return `<div class="res-card ${can && active ? 'buyable' : ''}" onclick="${can && active ? `handleBuy('${c.id}', ${c.level}, true)` : ''}">
                        <div style="position:absolute; top:2px; right:2px; width:8px; height:8px; border-radius:50%; background:${s.light}; border:1px solid white;"></div>
                        <span style="font-weight:bold; font-family:'Times New Roman'; font-size:14px; color:white;">${c.points||''}</span>
                     </div>`;
                }).join('');
                // Fill empty slots
                for(let i=0; i< 3 - p.reserved.length; i++) {
                    resHtml += `<div class="res-slot">${getSvg('lock', '', 'width:12px; opacity:0.3')}</div>`;
                }

                return `<div class="player-panel ${active?'active':''}">
                    ${active ? '<div class="active-bar"></div>' : ''}
                    <div class="p-info">
                        <div class="p-avatar">${getSvg('user', '', 'width:24px')}</div>
                        <div style="font-size:14px; font-weight:bold; color:${active?'white':'#64748b'}">${p.name}</div>
                        <div class="p-score">${p.score}</div>
                    </div>
                    <div class="p-nobles no-scrollbar">${noblesHtml}</div>
                    <div class="p-resources">
                        <div class="res-row">${tokensHtml}</div>
                        <div class="res-row" style="background:rgba(0,0,0,0.2)">${cardsHtml}</div>
                    </div>
                    <div class="p-reserved">
                        <div style="font-size:10px; margin-bottom:2px; opacity:0.5">预留</div>
                        <div class="res-grid">${resHtml}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // Start
        initGame();
        
    </script>
</body>
</html>
